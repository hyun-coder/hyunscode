<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ì›”ê¸‰ ê³„ì‚° Ver.1.5.2 [GDì‹œíì–´]</title>
    <style>
        /* === 1. ë‹¤í¬ ëª¨ë“œ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        :root {
            --color-bg: #121212;
            --color-surface: #1E1E1E;
            --color-text: #E0E0E0;
            --color-text-secondary: #AAAAAA; /* Slightly dimmer text */
            --color-primary: #00BFFF; /* Bright cyan */
            --color-secondary: #FF6F00; /* Orange */
            --color-error: #CF6679;
            --color-highlight: rgba(0, 191, 255, 0.15);
            --color-disabled: #383838;
            --color-border: #444444;
            --color-night-shift-dark: #2A3B4D; /* 1. ë‹¤í¬ëª¨ë“œ ì•¼ê°„ í‘œì‹œ ìƒ‰ìƒ ë³€ê²½ (Dark Slate Blue) */
            --shadow-elevation: 0 4px 8px rgba(0, 0, 0, 0.5);
            --mobile-padding: 16px;
        }

        /* === 4. ë¼ì´íŠ¸ ëª¨ë“œ ë³€ìˆ˜ (ê°€ë…ì„± ê°œì„ ) === */
        :root.light-mode {
            --color-bg: #F5F5F5; /* Light grey background */
            --color-surface: #FFFFFF; /* White surface */
            --color-text: #212121; /* Dark grey text */
            --color-text-secondary: #757575; /* Medium grey text */
            --color-primary: #1976D2; /* Readable Blue */
            --color-secondary: #FFA000; /* Amber/Orange */
            --color-error: #D32F2F; /* Red */
            --color-highlight: rgba(25, 118, 210, 0.1); /* Lighter blue highlight */
            --color-disabled: #BDBDBD; /* Light grey disabled */
            --color-border: #E0E0E0; /* Lighter border */
            --color-night-shift-dark: #E3F2FD; /* Light blue background for night shift in Light Mode */
            --shadow-elevation: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* === 4. ë¼ì´íŠ¸ ëª¨ë“œ íŠ¹í™” ìŠ¤íƒ€ì¼ === */
        :root.light-mode .day-cell {
            background-color: #FAFAFA; /* Slightly off-white cells */
        }
        :root.light-mode .day-cell.disabled {
            background-color: #EEEEEE; /* Lighter disabled background */
            color: var(--color-disabled);
        }
        :root.light-mode .day-cell.night-shift-background {
            background-color: var(--color-night-shift-dark); /* Light blue background for night shift */
        }
        :root.light-mode .day-cell.night-shift-background.disabled {
            background-color: #ECEFF1; /* Even lighter blue-grey */
        }
        :root.light-mode .input-group input,
        :root.light-mode .input-group select,
        :root.light-mode .overtime-input-row select,
        :root.light-mode .overtime-input-row input,
        :root.light-mode #stats-year-filter,
        :root.light-mode #stats-month-filter {
            background-color: #FFFFFF; /* White inputs */
            color: var(--color-text);
            border: 1px solid var(--color-border); /* Clearer border */
        }
        :root.light-mode .radio-group label {
            background-color: #EEEEEE; /* Light grey pills */
            color: var(--color-text-secondary);
        }
        :root.light-mode .radio-group input[type="radio"]:checked + label {
            background-color: var(--color-primary);
            color: #FFFFFF; /* White text on primary */
        }
        :root.light-mode .modal-actions button.primary {
            color: #FFFFFF; /* Ensure white text */
        }
        :root.light-mode .modal-actions button.secondary {
            background-color: #E0E0E0; /* Light grey secondary button */
            color: #424242; /* Darker text */
        }
        :root.light-mode #tab-content-settings small {
            color: var(--color-text-secondary) !important;
        }
        :root.light-mode button { /* General button adjustments */
            color: var(--color-text);
        }
        :root.light-mode button[onclick^="add"],
        :root.light-mode button[onclick^="backup"],
        :root.light-mode button[onclick*="restore"] {
             background-color: #E0E0E0;
             color: #424242;
        }
        :root.light-mode button[onclick="copyPreviousMonthBasePay()"] {
            background-color: var(--color-secondary);
            color: #FFFFFF;
        }
        :root.light-mode button[onclick="resetAllData()"] {
            background-color: var(--color-error);
            color: #FFFFFF;
        }
        :root.light-mode .weekdays .saturday {
            color: var(--color-primary); /* Use primary blue for Saturday */
        }


        /* === 2. ë ˆì´ì•„ì›ƒ ë° íƒ­ === */
        .app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--color-surface);
            padding: 12px var(--mobile-padding);
            box-shadow: var(--shadow-elevation);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.4em;
            margin: 0;
            text-align: center;
        }

        .tab-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border); /* Use border color variable */
        }

        .tab-button {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 1em;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--color-text);
            opacity: 0.6;
            transition: opacity 0.3s, color 0.3s, border-bottom 0.3s;
        }

        .tab-button.active {
            color: var(--color-primary);
            opacity: 1;
            border-bottom: 3px solid var(--color-primary);
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            position: relative; /* ìì‹ ìš”ì†Œì˜ ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ */
        }

        /* === 3. ê¸‰ì—¬ ë° ì„¤ì • ì„¹ì…˜ (ìƒë‹¨ ê³ ì •) */
        #salary-input-section {
            background-color: var(--color-surface);
            padding: 10px var(--mobile-padding);
            margin-bottom: 10px;
            border-radius: 8px;
            margin: 10px var(--mobile-padding);
            position: relative; /* í† ê¸€ ë²„íŠ¼ ê¸°ì¤€ */
        }

        .salary-summary h2 {
            font-size: 1.6em;
            color: var(--color-primary);
            margin: 0 0 5px 0;
        }

        .salary-summary small {
            color: var(--color-text-secondary); /* Use secondary text color */
        }

        .salary-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group, .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .input-group label {
            flex: 2;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            flex: 3;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: 1em;
        }

        .checkbox-group label {
            flex: 3;
            font-size: 0.9em;
        }

        #additional-items-list div {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        #additional-items-list input {
            flex: 1;
        }

        /* í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #toggle-salary-details {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--color-primary);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s;
            line-height: 1;
        }

        .collapsed #toggle-salary-details {
            transform: rotate(180deg);
        }

        #salary-details-container.collapsed {
            display: none;
        }

         #calculated-stats {
             background-color: var(--color-bg) !important; /* Ensure background matches body */
             border: 1px solid var(--color-border) !important;
         }
         #calculated-stats .stats-row span:first-child {
             color: var(--color-text-secondary); /* Dimmer labels */
         }

        /* === 4. ë‹¬ë ¥ ì„¹ì…˜ === */
        #calendar-view {
            overflow-y: scroll;
            height: calc(100vh - 200px); /* í—¤ë” ë° ê¸‰ì—¬ ì„¹ì…˜ì„ ì œì™¸í•œ ë†’ì´ */
            scroll-snap-type: y mandatory;
        }

        .calendar-month {
            scroll-snap-align: center;
            background-color: var(--color-surface);
            margin: 10px var(--mobile-padding);
            border-radius: 8px;
            padding: 10px;
            opacity: 0.3; /* ë¹„í™œì„±í™”ëœ ë‹¬ì€ íë¦¬ê²Œ */
            transition: opacity 0.3s, transform 0.3s;
        }

        .calendar-month.active {
            opacity: 1; /* í™œì„±í™”ëœ ë‹¬ì€ ì„ ëª…í•˜ê²Œ */
        }

        .month-header {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .weekdays span {
            color: var(--color-text-secondary); /* Dimmer weekday names */
        }
        .weekdays .sunday {
            color: var(--color-error); /* ì¼ìš”ì¼ ë¶‰ì€ìƒ‰ */
        }
        .weekdays .saturday {
            color: var(--color-primary); /* í† ìš”ì¼ íŒŒë€ìƒ‰ ê³„ì—´ */
        }


        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
            border-radius: 6px;
            font-size: 1em;
            min-height: 50px;
            cursor: pointer;
            position: relative;
            background-color: var(--color-bg);
            transition: background-color 0.2s;
            border: 1px solid transparent; /* Add border for today */
        }

        /* 1. ë‹¤í¬ëª¨ë“œ ì•¼ê°„ í‘œì‹œ ìƒ‰ìƒ ë³€ìˆ˜ ì‚¬ìš© */
        .day-cell.night-shift-background {
            background-color: var(--color-night-shift-dark);
        }
        /* ë¼ì´íŠ¸ ëª¨ë“œ ìŠ¤íƒ€ì¼ì€ :root.light-mode ì—ì„œ ì²˜ë¦¬ */
        :root:not(.light-mode) .day-cell.night-shift-background.disabled {
             background-color: #262626; /* ê¸°ì¡´ ì–´ë‘ìš´ ìƒ‰ ìœ ì§€ (ë‹¤í¬ëª¨ë“œ ë¹„í™œì„±) */
             opacity: 0.7;
        }


        .day-cell:not(.disabled):active {
            background-color: var(--color-highlight);
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 1em;
        }

        .day-status {
            font-size: 0.7em;
            font-weight: 500;
            color: var(--color-primary);
            margin-bottom: 1px;
            line-height: 1;
            min-height: 0.8em; /* í…ìŠ¤íŠ¸ê°€ ì—†ì„ ë•Œ ë†’ì´ ìœ ì§€ */
        }

        .day-overtime {
            font-size: 0.7em;
            color: var(--color-secondary);
            min-height: 0.8em;
            line-height: 1;
        }

        .holiday .day-number {
            color: var(--color-error); /* ê³µíœ´ì¼ì€ ë¶‰ì€ìƒ‰ */
        }
        
        /* === ë‹¬ë ¥ ë‚ ì§œ ì‹œê°ì  ë¹„í™œì„±í™” ìˆ˜ì • === */
        /* disabled í´ë˜ìŠ¤ê°€ ì ìš©ëœ ìš”ì†Œì—ë§Œ ìƒ‰ìƒ ë³€ê²½ ë° í¬ì¸í„° ë¹„í™œì„±í™” */
        .day-cell.disabled {
            color: var(--color-disabled);
            background-color: var(--color-surface); /* í˜„ì¬ ë‹¬ë ¥ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ */
            cursor: default;
            opacity: 0.6; /* íë¦¿í•˜ê²Œ í‘œì‹œ */
        }

        .today {
            border: 1px solid var(--color-secondary); /* Change border style for today */
        }

        /* === 5. ëª¨ë‹¬ (ì…ë ¥/ì„¤ì • íŒì—…) === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Slightly less opaque */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-content {
            background-color: var(--color-surface);
            padding: var(--mobile-padding);
            border-radius: 12px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-elevation);
        }

        .modal-content h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
            color: var(--color-primary);
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            background-color: var(--color-bg);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: normal;
            border: 1px solid var(--color-border); /* Add border to pills */
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: var(--color-primary);
            color: var(--color-bg); /* Use bg color for contrast */
            font-weight: bold;
            border-color: var(--color-primary);
        }

        /* ì”ì—… ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .overtime-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 0.5fr;
            gap: 10px;
            align-items: center;
            margin-top: 5px;
        }

        .overtime-input-row select, .overtime-input-row input {
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: 0.9em;
        }
        
        /* ì”ì—… ì…ë ¥ readonly ìŠ¤íƒ€ì¼ */
        .overtime-input-row input[readonly] {
            cursor: default;
            opacity: 0.8;
            background-color: var(--color-disabled); /* ì…ë ¥ ë¹„í™œì„±í™” ì‹œ ë°°ê²½ìƒ‰ ì¡°ì • */
            color: var(--color-text-secondary);
        }


        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .modal-actions button.primary {
            background-color: var(--color-primary);
            color: var(--color-bg);
        }

        .modal-actions button.secondary {
            background-color: var(--color-disabled);
            color: var(--color-text);
        }

        .modal-actions button.danger {
            background-color: var(--color-error);
            color: #FFFFFF; /* White text on red */
        }

        /* ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° */
        .float-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--color-secondary);
            color: var(--color-bg);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-elevation);
            z-index: 150;
        }

        /* í†µê³„ ì‹œíŠ¸ ìŠ¤íƒ€ì¼ */
        #statistics-view {
            padding: var(--mobile-padding);
        }

        .stats-filter {
            display: flex; /* ë“œë¡­ë°•ìŠ¤ í¬ê¸° ì¡°ì •ì„ ìœ„í•´ flex ì ìš© */
            gap: 10px;
            margin-bottom: 20px;
        }
        .stats-filter select {
            flex: 1; /* í¬ê¸° ì¡°ì • ë°˜ì˜ */
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th, .stats-table td {
            padding: 12px 5px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.9em;
            white-space: nowrap;
        }

        .stats-table th {
            color: var(--color-primary);
            font-weight: bold;
        }

        .stats-summary-row {
            background-color: var(--color-bg);
            font-weight: bold;
        }

        .stats-table td:not(:first-child), .stats-table th:not(:first-child) {
            text-align: right;
        }


        /* ì„¤ì • ì„¹ì…˜ ë‚´ small íƒœê·¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
        #tab-content-settings small {
            color: var(--color-text-secondary) !important;
            opacity: 1; /* Opacity adjusted by color variable */
        }

        /* ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ */
        #initial-setup-modal .modal-content {
            width: 80%;
        }

        #initial-setup-modal input {
            width: 100%;
            box-sizing: border-box;
        }

        /* ì”ì—… ì¢…ë¥˜ ê´€ë¦¬ */
        #overtime-list-container div,
        .change-record-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        #overtime-list-container input {
            flex: 1;
        }

        .change-record-row select, .change-record-row input[type="date"] {
            flex: 1;
        }

        /* 4. ë¼ì´íŠ¸ ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        #theme-toggle {
            cursor: pointer;
             /* Use accent-color for styling if supported */
            accent-color: var(--color-primary);
             min-width: 1.5em; /* Ensure minimum size */
             min-height: 1.5em;
        }

        hr {
            border: none;
            border-top: 1px solid var(--color-border);
        }


    </style>
</head>
<body>

    <div class="app-container">

        <header class="header">
            <h1 id="app-title">ìŠ¤ë§ˆíŠ¸ ì›”ê¸‰ ê³„ì‚°</h1>
            <button id="today-button" class="float-button" title="ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ë™" style="bottom: auto; top: 10px; right: 10px; width: 40px; height: 40px; font-size: 1.2em;">ğŸ“…</button>
        </header>

        <div class="tab-bar">
            <button class="tab-button active" id="tab-calendar">ë‹¬ë ¥/ì…ë ¥</button>
            <button class="tab-button" id="tab-statistics">í†µê³„</button>
            <button class="tab-button" id="tab-settings">ì„¤ì •</button>
        </div>

        <div class="content-area">

            <div id="tab-content-calendar" class="tab-content">

                <section id="salary-input-section">
                    <div class="salary-summary-header">
                        <div>
                            <small id="salary-period-info">ì´ ì˜ˆìƒ ì›”ê¸‰ (ê¸°ê°„ ì •ë³´ ë¡œë”© ì¤‘...)</small>
                            <h2 id="total-expected-salary">0 ì›</h2>
                        </div>
                        <button id="toggle-salary-details" onclick="toggleSalaryDetails()">â–¼</button>
                    </div>

                    <div id="salary-details-container">
                        <div id="current-salary-options" style="font-size:0.8em; color: var(--color-primary);"></div>

                        <div id="calculated-stats" style="margin-top: 5px; margin-bottom: 15px; padding: 10px; border: 1px solid var(--color-disabled); border-radius: 4px; background-color: var(--color-bg);">
                            <div class="stats-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="flex: 2; color: var(--color-text-secondary);">í‰ì¼ì”ì—…ì‹œê°„:</span>
                                <span id="stat-weekday-ot-time-count" style="flex: 1; text-align: right; font-weight: bold; margin-right: 10px;">0.0h</span>
                                <span id="stat-weekday-ot-time-amount" style="flex: 2; text-align: right; color: var(--color-primary);">0 ì›</span>
                            </div>
                            <div class="stats-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="flex: 2; color: var(--color-text-secondary);">íŠ¹ê·¼ì”ì—…ì‹œê°„:</span>
                                <span id="stat-special-ot-time-count" style="flex: 1; text-align: right; font-weight: bold; margin-right: 10px;">0.0h</span>
                                <span id="stat-special-ot-time-amount" style="flex: 2; text-align: right; color: var(--color-primary);">0 ì›</span>
                            </div>
                            <div class="stats-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="flex: 2; color: var(--color-text-secondary);">íŠ¹ê·¼ì¼ìˆ˜:</span>
                                <span id="stat-special-day-count-count" style="flex: 1; text-align: right; font-weight: bold; margin-right: 10px;">0ì¼</span>
                                <span id="stat-special-day-count-amount" style="flex: 2; text-align: right; color: var(--color-primary);">0 ì›</span>
                            </div>
                            <div class="stats-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="flex: 2; color: var(--color-text-secondary);">ì•¼ê°„ì¼ìˆ˜:</span>
                                <span id="stat-night-day-count-count" style="flex: 1; text-align: right; font-weight: bold; margin-right: 10px;">0ì¼</span>
                                <span id="stat-night-day-count-amount" style="flex: 2; text-align: right; color: var(--color-primary);">0 ì›</span>
                            </div>
                        </div>

                        <div class="input-group" style="margin-top: 10px;">
                            <label for="base-pay">ê¸°ë³¸ê¸‰ ì…ë ¥</label>
                            <div style="display:flex; gap: 5px; flex: 3;">
                                <input type="number" id="base-pay" placeholder="ê¸°ë³¸ê¸‰" oninput="saveBasePaySetting()" style="flex: 1;">
                                <button onclick="copyPreviousMonthBasePay()" style="background-color: var(--color-secondary); color: var(--color-bg); padding: 5px 10px; border: none; border-radius: 4px; font-size: 0.8em; line-height: 1.2; text-align: center; width: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">ì´ì „ë‹¬<br>ê¸°ë³¸ê¸‰</button>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <label for="regular-pay-check">í†µìƒì„ê¸ˆ í¬í•¨ (ì”ì—… ì‹œê¸‰ ê³„ì‚°ì— ë°˜ì˜)</label>
                            <input type="checkbox" id="regular-pay-check" onchange="saveRegularPayCheckSetting()" style="accent-color: var(--color-primary);">
                        </div>

                        <hr>

                        <label style="font-size: 0.9em;">ì¶”ê°€ ìˆ˜ë‹¹ ëª©ë¡ (ìƒì—¬, êµí†µë¹„, ì‹ëŒ€ ë“± - í˜„ì¬ ê¸°ê°„ì—ë§Œ ì ìš©):</label>
                        <div id="additional-items-list">
                            </div>
                        <button onclick="addAdditionalItem()" style="background-color: var(--color-disabled); color: var(--color-text); padding: 5px 10px; border: none; border-radius: 4px; margin-top: 5px;">+ ì¶”ê°€ í•­ëª©</button>
                    </div>

                </section>

                <div id="calendar-view">
                    </div>
            </div>

            <div id="tab-content-statistics" class="tab-content" style="display:none;">
                <section id="statistics-view">
                    <h3>ì›”ë³„ ê·¼ë¬´ í†µê³„</h3>
                    <div id="stats-total-sum" style="font-size: 1.5em; color: var(--color-secondary); margin-bottom: 15px; text-align: right;">ì´ í•©ê³„: 0 ì›</div>

                    <div class="stats-filter" style="display:flex; gap: 10px;">
                        <select id="stats-year-filter" onchange="renderStatistics()" style="flex: 1;"></select>
                        <select id="stats-month-filter" onchange="renderStatistics()" style="flex: 1;">
                            <option value="0">ì „ì²´ ì›”</option>
                            <option value="1">1ì›”</option>
                            <option value="2">2ì›”</option>
                            <option value="3">3ì›”</option>
                            <option value="4">4ì›”</option>
                            <option value="5">5ì›”</option>
                            <option value="6">6ì›”</option>
                            <option value="7">7ì›”</option>
                            <option value="8">8ì›”</option>
                            <option value="9">9ì›”</option>
                            <option value="10">10ì›”</option>
                            <option value="11">11ì›”</option>
                            <option value="12">12ì›”</option>
                        </select>
                    </div>

                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>ê¸°ê°„</th>
                                <th>ì´ ê¸‰ì—¬</th>
                                <th>ì•¼ê°„</th>
                                <th>íŠ¹ê·¼</th>
                                <th>íœ´ê°€/ë°˜ì°¨</th>
                                </tr>
                        </thead>
                        <tbody id="stats-table-body">
                            </tbody>
                    </table>
                </section>
            </div>

            <div id="tab-content-settings" class="tab-content" style="display:none;">
                <section style="padding: var(--mobile-padding);">
                    <h3>ì‚¬ìš©ì ë° ë°˜ ì„¤ì •</h3>
                    <div class="form-row">
                        <label for="setting-account">ë‚´ ê³„ì • ì •ë³´ (ê¸°ê¸°ë‹¹ ê³ ìœ )</label>
                        <input type="text" id="setting-account" disabled>
                    </div>
                    <div class="form-row">
                        <label for="setting-class">ì†Œì† ë°˜ (í˜„ì¬ ê¸°ì¤€)</label>
                        <select id="setting-class" onchange="saveSettings();">
                            <option value="A">Aë°˜</option>
                            <option value="B">Bë°˜</option>
                            <option value="C">Cë°˜</option>
                            <option value="D">Dë°˜</option> </select>
                    </div>
                    <div class="form-row">
                        <label for="setting-a-night">Aë°˜ ì•¼ê°„ ì‹œì‘ì¼ (ê¸°ì¤€ì¼)</label>
                        <input type="date" id="setting-a-night" onchange="saveSettings(); generateCalendar();">
                        <small>* ì´ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ë³„ ì•¼ê°„ ë¡œí…Œì´ì…˜ì´ ê³„ì‚°ë©ë‹ˆë‹¤. (ì „ì—­ ê¸°ì¤€ì¼, **ë°˜ë“œì‹œ ì¼ìš”ì¼ì´ì–´ì•¼ í•¨**)</small>
                    </div>

                    <hr>

                    <h3>ë°˜ ë³€ê²½ ê¸°ë¡ ê´€ë¦¬ (ê°œì¸ íŒ¨í„´ ë³€ê²½)</h3>
                    <small>* ë°˜ ë³€ê²½ì¼ ì´í›„ë¶€í„° **ë³€ê²½ëœ ë°˜ì˜ ë¡œí…Œì´ì…˜**ì´ **ê³ ì •ëœ Aë°˜ ì•¼ê°„ ì‹œì‘ì¼**ì„ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</small>
                    <div id="class-change-history-list">
                    </div>
                    <button onclick="addClassChangeRecordInput()" style="background-color: var(--color-disabled); color: var(--color-text); padding: 5px 10px; border: none; border-radius: 4px; margin-top: 5px;">+ ë°˜ ë³€ê²½ ê¸°ë¡ ì¶”ê°€</button>

                    <hr>

                    <h3>ì”ì—… ì¢…ë¥˜ ê´€ë¦¬</h3>
                    <div class="form-row">
                        <label style="font-size: 0.9em;">ì”ì—… ì´ë¦„ê³¼ ê¸°ë³¸ ì‹œê°„(h)ì„ ì„¤ì •í•©ë‹ˆë‹¤.</label>
                        <div id="overtime-list-container">
                        </div>
                        <button onclick="addOvertimeSettingItem()" style="background-color: var(--color-disabled); color: var(--color-text); padding: 5px 10px; border: none; border-radius: 4px; margin-top: 5px;">+ ì”ì—… ì¢…ë¥˜ ì¶”ê°€</button>
                    </div>

                    <hr>

                    <h3>ì‚¬ìš©ì ì§€ì • ê³µíœ´ì¼</h3>
                    <div id="custom-holidays-list">
                        </div>
                    <button onclick="addCustomHolidayInput()" style="background-color: var(--color-disabled); color: var(--color-text); padding: 5px 10px; border: none; border-radius: 4px; margin-top: 5px;">+ ê³µíœ´ì¼ ì¶”ê°€</button>

                    <hr>
                    <h3>í…Œë§ˆ ì„¤ì •</h3>
                    <div class="form-row checkbox-group" style="align-items: center;">
                        <label for="theme-toggle" style="flex: 5;">ë¼ì´íŠ¸ ëª¨ë“œ í™œì„±í™”</label>
                        <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)" style="flex: 1; height: 1.5em; width: 1.5em;">
                    </div>

                    <hr>
                    <h3>ë°ì´í„° ë°±ì—…/ë³µêµ¬</h3>
                    <div class="form-row" style="display:flex; gap: 10px;">
                        <button onclick="backupData()"
                                style="flex: 1; padding: 10px; border: none; border-radius: 4px; background-color: var(--color-primary); color: var(--color-bg); cursor: pointer; font-weight: bold;">
                            ë°±ì—… (ë‚´ë³´ë‚´ê¸°)
                        </button>
                        <button onclick="document.getElementById('file-upload-input').click()"
                                style="flex: 1; padding: 10px; border: none; border-radius: 4px; background-color: var(--color-disabled); color: var(--color-text); cursor: pointer; font-weight: bold;">
                            ë³µêµ¬ (ê°€ì ¸ì˜¤ê¸°)
                        </button>
                        <input type="file" id="file-upload-input" accept="application/json" onchange="restoreData(event)" style="display:none;">
                    </div>

                    <hr>

                    <button onclick="resetAllData()"
                            style="width: 100%;
                                   background-color: var(--color-error);
                                   color: #FFFFFF; /* White text on red */
                                   padding: 10px 20px;
                                   border: none;
                                   border-radius: 20px;
                                   font-size: 1em;
                                   cursor: pointer;">
                        ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (ì£¼ì˜)
                    </button>

                </section>
            </div>

        </div>

    </div>

    <div id="work-record-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-date-title">ê·¼ë¬´ ê¸°ë¡ ì…ë ¥</h3>
            <input type="hidden" id="modal-selected-date">

            <div class="form-row">
                <label>ê·¼ë¬´ í˜•íƒœ</label>
                <div class="radio-group" id="work-type-group">
                    <input type="radio" id="type-ì£¼ê°„" name="work-type" value="ì£¼ê°„"><label for="type-ì£¼ê°„">ì£¼ê°„</label>
                    <input type="radio" id="type-ì•¼ê°„" name="work-type" value="ì•¼ê°„"><label for="type-ì•¼ê°„">ì•¼ê°„</label>
                    <input type="radio" id="type-ì£¼íŠ¹" name="work-type" value="ì£¼ê°„íŠ¹ê·¼"><label for="type-ì£¼íŠ¹">ì£¼ê°„íŠ¹ê·¼</label>
                    <input type="radio" id="type-ì•¼íŠ¹" name="work-type" value="ì•¼ê°„íŠ¹ê·¼"><label for="type-ì•¼íŠ¹">ì•¼ê°„íŠ¹ê·¼</label>
                    <input type="radio" id="type-17ì‹œ" name="work-type" value="17ì‹œí‡´ê·¼"><label for="type-17ì‹œ">17ì‹œ í‡´ê·¼</label>
                    <input type="radio" id="type-íœ´ë¬´" name="work-type" value="íœ´ë¬´"><label for="type-íœ´ë¬´">íœ´ë¬´</label>
                    <input type="radio" id="type-íœ´ê°€" name="work-type" value="íœ´ê°€"><label for="type-íœ´ê°€">íœ´ê°€</label>
                    <input type="radio" id="type-ë°˜ì°¨" name="work-type" value="ë°˜ì°¨"><label for="type-ë°˜ì°¨">ë°˜ì°¨ (0.5ì¼)</label>
                    <input type="radio" id="type-ë¯¸ì„ íƒ" name="work-type" value="ë¯¸ì„ íƒ"><label for="type-ë¯¸ì„ íƒ">ë¯¸ì„ íƒ (ê³„ì‚° ì œì™¸)</label>
                </div>
            </div>

            <div class="form-row" id="overtime-input-section">
                <label>ì¶”ê°€ ê·¼ë¬´ (ì¡°ì¶œ/ì§€ì›)</label>
                <div class="overtime-input-row" style="font-weight: bold; color: var(--color-primary);">
                    <div>ì¢…ë¥˜</div>
                    <div>ì‹œê°„ (h)</div>
                    <div>ì‚­ì œ</div>
                </div>
                <div id="modal-overtime-list">
                    </div>
                <button onclick="addOvertimeRow(true)" style="background-color: var(--color-disabled); color: var(--color-text); padding: 5px 10px; border: none; border-radius: 4px; margin-top: 10px;">+ ì”ì—… ì¶”ê°€</button>
            </div>

            <div class="modal-actions">
                <button onclick="closeModal('work-record-modal')" class="secondary">ë‹«ê¸°</button>
                <button onclick="deleteWorkRecord()" class="danger" id="delete-record-btn" style="display:none;">ì‚­ì œ</button>
                <button onclick="saveWorkRecord()" class="primary">ì €ì¥/ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <div id="initial-setup-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>ìŠ¤ë§ˆíŠ¸ ì›”ê¸‰ ê³„ì‚° ì´ˆê¸° ì„¤ì •</h3>
            <p>ì•±ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ë°ì´í„°ëŠ” í˜„ì¬ ê¸°ê¸°ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <div class="form-row">
                <label for="init-class">ì†Œì† ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.</label>
                <select id="init-class">
                    <option value="A">Aë°˜</option>
                    <option value="B">Bë°˜</option>
                    <option value="C">Cë°˜</option>
                    <option value="D">Dë°˜</option> </select>
            </div>
            <div class="form-row">
                <label for="init-a-night">Aë°˜ ì•¼ê°„ ë¡œí…Œì´ì…˜ ì‹œì‘ì¼ (YYYY-MM-DD)</label>
                <input type="date" id="init-a-night" value="2025-10-05">
                <small>* ì˜ˆì‹œ: 2025ë…„ 10ì›” 5ì¼ (Bë°˜ ì•¼ê°„ ì‹œì‘ 2025/10/12 ê¸°ì¤€, **ì¼ìš”ì¼ë¡œ ì„¤ì •í•´ì•¼ í•¨**)</small>
            </div>
            <div class="modal-actions">
                <button onclick="completeInitialSetup()" class="primary" style="width: 100%;">ì„¤ì • ì™„ë£Œ ë° ì‹œì‘</button>
            </div>
        </div>
    </div>


    <script>
        // =======================================================================
        // === JavaScript Core Logic (ìˆ˜ì •ëœ ë¡œì§ ì ìš© - V1.5.2) ===
        // =======================================================================

        const CURRENT_APP_VERSION = "1.5.2";

        // 1. ë°ì´í„° ì €ì¥ ë° ì´ˆê¸°í™”
        let USER_DATA = {
            appVersion: CURRENT_APP_VERSION,
            account: Date.now().toString(),
            class: 'A',
            A_night_start: '2025-10-05',
            settings: {
                basePays: {},
                regularPayChecks: {},
                additionalItemsByPeriod: {},
                customHolidays: [],
                isSalaryDetailsCollapsed: false,
                classChangeHistory: [],
                isLightMode: false,
                overtimeList: [
                    { name: 'ê¸°ë³¸ ì”ì—…', time: 0.0 },
                    { name: 'G1ì¡°ì¶œ', time: 1.0 }, { name: 'G2ì¡°ì¶œ', time: 1.0 },
                    { name: 'G2ì§€ì›', time: 0.5 }, { name: 'G3ì¡°ì¶œ', time: 1.0 },
                    { name: 'G5ì¡°ì¶œ', time: 1.0 }, { name: 'G5ì§€ì›', time: 0.5 },
                    { name: 'R&Dì¡°ì¶œ', time: 1.0 }, { name: 'R&Dì§€ì›', time: 0.5 },
                    { name: 'ë²„ìŠ¤ê²€ì°¨', time: 0.5 }
                ]
            },
            workRecords: {}
        };

        // --- ê¸‰ì—¬ ê¸°ê°„ ê´€ë ¨ í—¬í¼ í•¨ìˆ˜ ---
        function getPeriodKeyFromDate(date) {
            let year = date.getFullYear();
            let month = date.getMonth(); // 0-11

            if (date.getDate() < 20) {
                month--;
                if (month < 0) {
                    month = 11;
                    year--;
                }
            }
            return `${year}-${String(month + 1).padStart(2, '0')}`;
        }

        function getCurrentActivePeriodKey() {
            const activeMonthElement = document.querySelector('.calendar-month.active');
            if (!activeMonthElement) {
                return getPeriodKeyFromDate(new Date());
            }

            const idParts = activeMonthElement.id.split('-');
            const activeYear = Number(idParts[1]);
            const activeMonthIndex = Number(idParts[2]);

            const dateOn1st = new Date(activeYear, activeMonthIndex, 1);
            return getPeriodKeyFromDate(dateOn1st);
        }

        function getSalaryPeriodByPeriodKey(periodKey) {
            if (!periodKey) return null;
            const [periodYear, periodMonth] = periodKey.split('-').map(Number);

            const startDay = 20;
            const endDay = 19;

            const startDate = new Date(periodYear, periodMonth - 1, startDay);
            const endDate = new Date(periodYear, periodMonth, endDay);
            endDate.setHours(23, 59, 59, 999);

            return { startDate, endDate };
        }


        function getPreviousPeriodKey(currentKey) {
            if (!currentKey) return null;
            const [year, month] = currentKey.split('-').map(Number);

            let prevYear = year;
            let prevMonth = month - 1;

            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear--;
            }
            return `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
        }
        // ------------------------------------

        function saveData() {
            USER_DATA.appVersion = CURRENT_APP_VERSION;
            USER_DATA.settings.classChangeHistory.sort((a, b) => new Date(a.changeDate) - new Date(b.changeDate));
            localStorage.setItem('smartSalaryApp_user_data', JSON.stringify(USER_DATA));
        }

        function migrateDataV1_x_x(data) {
             console.log("Applying migration for V1.x.x structure...");
             if (data.settings) {
                 const today = new Date();
                 const currentKey = getPeriodKeyFromDate(today);

                 if (data.settings.basePay !== undefined) {
                     data.settings.basePays = { [currentKey]: data.settings.basePay };
                     delete data.settings.basePay;
                 }
                 if (data.settings.isRegularPay !== undefined && data.settings.regularPayChecks === undefined) {
                     data.settings.regularPayChecks = { [currentKey]: data.settings.isRegularPay };
                     delete data.settings.isRegularPay;
                 }
                 if (!data.settings.additionalItemsByPeriod) {
                     data.settings.additionalItemsByPeriod = {};
                     if (data.settings.additionalItems && data.settings.additionalItems.length > 0) {
                         data.settings.additionalItemsByPeriod[currentKey] = data.settings.additionalItems;
                     }
                     delete data.settings.additionalItems;
                 }
                 if (data.settings.customHolidays && data.settings.customHolidays.length > 0) {
                     if (typeof data.settings.customHolidays[0] === 'string') {
                         data.settings.customHolidays = data.settings.customHolidays.map(dateStr => ({ date: dateStr, name: 'ì‚¬ìš©ì ì§€ì • ê³µíœ´ì¼' }));
                     }
                 }
                 if (!data.settings.basePays) data.settings.basePays = {};
                 if (!data.settings.regularPayChecks) data.settings.regularPayChecks = {};
                 if (!data.settings.additionalItemsByPeriod) data.settings.additionalItemsByPeriod = {};
                 if (data.settings.isSalaryDetailsCollapsed === undefined) data.settings.isSalaryDetailsCollapsed = false;
                 if (data.settings.isLightMode === undefined) data.settings.isLightMode = false;
                 if (!data.settings.overtimeList) {
                     data.settings.overtimeList = [
                         { name: 'ê¸°ë³¸ ì”ì—…', time: 0.0 },
                         { name: 'G1ì¡°ì¶œ', time: 1.0 }, { name: 'G2ì¡°ì¶œ', time: 1.0 },
                         { name: 'G2ì§€ì›', time: 0.5 }, { name: 'G3ì¡°ì¶œ', time: 1.0 },
                         { name: 'G5ì¡°ì¶œ', time: 1.0 }, { name: 'G5ì§€ì›', time: 0.5 },
                         { name: 'R&Dì¡°ì¶œ', time: 1.0 }, { name: 'R&Dì§€ì›', time: 0.5 },
                         { name: 'ë²„ìŠ¤ê²€ì°¨', time: 0.5 }
                     ];
                 }
                 if (!data.settings.classChangeHistory) data.settings.classChangeHistory = [];
                 if (!data.settings.customHolidays) data.settings.customHolidays = [];
             }
             return data;
        }


        function loadData() {
            const data = localStorage.getItem('smartSalaryApp_user_data');
            if (data) {
                let loadedData;
                try {
                    loadedData = JSON.parse(data);
                } catch (e) {
                    console.error("Failed to parse stored data:", e);
                    alert("ì €ì¥ëœ ë°ì´í„°ë¥¼ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    document.getElementById('initial-setup-modal').style.display = 'flex';
                    return;
                }

                const loadedVersion = loadedData.appVersion;
                if (!loadedVersion || loadedVersion < CURRENT_APP_VERSION) {
                    console.log(`Migrating data from version ${loadedVersion || 'unknown'} to ${CURRENT_APP_VERSION}`);
                    try {
                        if (!loadedVersion) { 
                            loadedData = migrateDataV1_x_x(loadedData);
                        }
                        loadedData.appVersion = CURRENT_APP_VERSION; 
                        console.log("Data migration completed.");
                    } catch (migrationError) {
                        console.error("Data migration failed:", migrationError);
                        alert("ë°ì´í„° êµ¬ì¡°ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•±ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°±ì—… í›„ ì´ˆê¸°í™”ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.");
                    }
                }

                if (!loadedData.settings) loadedData.settings = {};
                if (!loadedData.settings.basePays) loadedData.settings.basePays = {};
                if (loadedData.class !== 'A' && loadedData.class !== 'B' && loadedData.class !== 'C' && loadedData.class !== 'D') {
                    loadedData.class = 'A';
                }

                USER_DATA = loadedData;

                applyTheme(USER_DATA.settings.isLightMode);

                document.getElementById('setting-account').value = USER_DATA.account;
                const settingClassSelect = document.getElementById('setting-class');
                if (settingClassSelect.querySelector(`option[value="${USER_DATA.class}"]`)) {
                    settingClassSelect.value = USER_DATA.class;
                } else {
                    settingClassSelect.value = 'A'; 
                }
                
                document.getElementById('setting-a-night').value = USER_DATA.A_night_start;
                document.getElementById('theme-toggle').checked = USER_DATA.settings.isLightMode; 
                renderCustomHolidays();
                renderOvertimeSettings();
                renderClassChangeHistory();

                if (USER_DATA.settings.isSalaryDetailsCollapsed) {
                    document.getElementById('salary-input-section').classList.add('collapsed');
                    document.getElementById('salary-details-container').classList.add('collapsed');
                    document.getElementById('toggle-salary-details').textContent = 'â–²';
                } else {
                    document.getElementById('salary-input-section').classList.remove('collapsed');
                    document.getElementById('salary-details-container').classList.remove('collapsed');
                    document.getElementById('toggle-salary-details').textContent = 'â–¼';
                }

                if (USER_DATA.account && USER_DATA.class && USER_DATA.A_night_start) {
                    document.getElementById('initial-setup-modal').style.display = 'none';
                    generateCalendar(true);
                    updateSalary();
                    switchTab('calendar'); 
                } else {
                    document.getElementById('initial-setup-modal').style.display = 'flex';
                }

            } else {
                applyTheme(USER_DATA.settings.isLightMode);
                document.getElementById('initial-setup-modal').style.display = 'flex';
            }
        }

        function saveBasePaySetting() {
            const currentKey = getCurrentActivePeriodKey();
            const basePayInput = document.getElementById('base-pay');
            if (currentKey) {
                USER_DATA.settings.basePays[currentKey] = Number(basePayInput.value) || 0;
                saveData();
                updateSalary();
            }
        }

        function saveRegularPayCheckSetting() {
            const currentKey = getCurrentActivePeriodKey();
            const isChecked = document.getElementById('regular-pay-check').checked;
            if (currentKey) {
                USER_DATA.settings.regularPayChecks[currentKey] = isChecked;
                saveData();
                updateSalary();
            }
        }

        function saveSettings() {
            USER_DATA.class = document.getElementById('setting-class').value;
            USER_DATA.A_night_start = document.getElementById('setting-a-night').value;
            saveData();
            generateCalendar();
            updateSalary();
        }

        function completeInitialSetup() {
            const initClass = document.getElementById('init-class').value;
            const initANightInput = document.getElementById('init-a-night');
            const initANight = initANightInput.value;

            if (!initANight) {
                alert("Aë°˜ ì•¼ê°„ ì‹œì‘ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                initANightInput.focus();
                return;
            }

            const checkDate = new Date(initANight);
            if (checkDate.getDay() !== 0) {
                 alert("Aë°˜ ì•¼ê°„ ì‹œì‘ì¼ì€ ë°˜ë“œì‹œ ì¼ìš”ì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                 initANightInput.focus();
                 return;
            }

            USER_DATA.class = initClass;
            USER_DATA.A_night_start = initANight;
            saveData();
            document.getElementById('initial-setup-modal').style.display = 'none';
            generateCalendar(true);
            updateSalary();
        }


        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function isHoliday(date) {
            const dateStr = formatDate(date);
            const customHolidays = USER_DATA.settings.customHolidays.map(h => h.date);
            return customHolidays.includes(dateStr);
        }

        function getClassForDate(date) {
            const dateStr = formatDate(date);
            let currentClass = USER_DATA.class;

            for (let i = USER_DATA.settings.classChangeHistory.length - 1; i >= 0; i--) {
                const record = USER_DATA.settings.classChangeHistory[i];
                if (dateStr >= record.changeDate) {
                    currentClass = record.newClass;
                    break;
                }
            }
            return currentClass;
        }

        // --- ê·¼ë¬´ í˜•íƒœ ê³„ì‚° (ë¡œí…Œì´ì…˜) ---
        function getCalculatedWorkType(date, classType, A_night_start_str) {
            const A_night_start = new Date(A_night_start_str);
            if (isNaN(A_night_start)) return { type: 'ë¯¸ì„ íƒ', status: 'ê¸°ì¤€ì¼ ì˜¤ë¥˜' };

            const oneDay = 24 * 60 * 60 * 1000;
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const A_night_start_only = new Date(A_night_start.getFullYear(), A_night_start.getMonth(), A_night_start.getDate());
            
            const diffDays = Math.floor((dateOnly.getTime() - A_night_start_only.getTime()) / oneDay);
            const week = Math.floor(diffDays / 7);
            const weekMod3 = (week % 3 + 3) % 3;

            let calculatedType = 'ì£¼ê°„';
            switch (classType) {
                case 'A': if (weekMod3 === 0) calculatedType = 'ì•¼ê°„'; break;
                case 'B': if (weekMod3 === 1) calculatedType = 'ì•¼ê°„'; break;
                case 'C': if (weekMod3 === 2) calculatedType = 'ì•¼ê°„'; break;
                case 'D': calculatedType = 'ì£¼ê°„'; break;
                default: calculatedType = 'ë¯¸ì„ íƒ';
            }
            return { type: calculatedType, status: `${classType}${calculatedType}` };
        }
        // ------------------------------------

        function calculateTotalOvertime(overtimes) {
            if (!overtimes || overtimes.length === 0) return 0;
            return overtimes.reduce((sum, item) => sum + (Number(item.time) || 0), 0);
        }

        // --- UI ë Œë”ë§ í•¨ìˆ˜ ---
        function generateCalendar(scrollToToday = false) {
            const calendarView = document.getElementById('calendar-view');
            calendarView.innerHTML = '';

            const today = new Date();
            const yearStart = today.getFullYear() - 1;
            const yearEnd = today.getFullYear() + 1;

            let monthsToRender = [];
            for (let y = yearStart; y <= yearEnd; y++) {
                for (let m = 0; m < 12; m++) {
                    monthsToRender.push(new Date(y, m, 1));
                }
            }
            monthsToRender.sort((a, b) => a.getTime() - b.getTime());

            let lastScrollMonthId = '';
            const todayStr = formatDate(today);

            monthsToRender.forEach(monthDate => {
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const daysInMonth = getDaysInMonth(year, month);
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDayOfWeek = firstDayOfMonth.getDay();
                const monthId = `month-${year}-${month}`;

                const monthElement = document.createElement('div');
                monthElement.className = 'calendar-month';
                monthElement.id = monthId;
                monthElement.innerHTML = `
                    <div class="month-header">${year}ë…„ ${month + 1}ì›”</div>
                    <div class="weekdays">
                        <span class="sunday">ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span class="saturday">í† </span>
                    </div>
                    <div class="calendar-grid"></div>
                `;
                const grid = monthElement.querySelector('.calendar-grid');

                for (let i = 0; i < firstDayOfWeek; i++) {
                    const prevMonthLastDay = new Date(year, month, 0).getDate();
                    const day = prevMonthLastDay - firstDayOfWeek + i + 1;
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell disabled';
                    dayCell.innerHTML = `<div class="day-number">${day}</div><div class="day-status"></div><div class="day-overtime"></div>`;
                    grid.appendChild(dayCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const dateStr = formatDate(currentDate);
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';

                    if (dateStr === todayStr) {
                        dayCell.classList.add('today');
                        lastScrollMonthId = monthId;
                    }
                    if (currentDate.getDay() === 0) dayCell.classList.add('holiday');
                    
                    const workRecord = USER_DATA.workRecords[dateStr];
                    const activeClass = getClassForDate(currentDate);
                    const calculated = getCalculatedWorkType(currentDate, activeClass, USER_DATA.A_night_start);
                    
                    let dayStatusText = ''; 
                    let isNightShift = calculated.type.includes('ì•¼ê°„'); // [ìˆ˜ì •ì‚¬í•­ 1] - ì•¼ê°„ í‘œì‹œ(ë°°ê²½)ëŠ” í•­ìƒ ë¡œí…Œì´ì…˜ ê²°ê³¼ë¡œ ê²°ì •
                    let overtimeText = '';

                    if (workRecord) {
                        // isNightShift = workRecord.type.includes('ì•¼ê°„') || workRecord.type.includes('ì•¼íŠ¹'); // ê¸°ì¡´ ì½”ë“œ ì‚­ì œ (ë°°ê²½ìƒ‰ ê³ ì •)
                        dayStatusText = workRecord.type === 'ë¯¸ì„ íƒ' ? '' : workRecord.type;
                        const totalOvertime = calculateTotalOvertime(workRecord.overtimes);
                        if (totalOvertime > 0) overtimeText = totalOvertime.toFixed(1) + 'h';
                    } else {
                        dayStatusText = ''; 
                    }

                    if (isHoliday(currentDate)) {
                        dayStatusText = 'ê³µíœ´ì¼';
                        dayCell.classList.add('holiday');
                    }
                    if (isNightShift) dayCell.classList.add('night-shift-background'); // [ìˆ˜ì •ì‚¬í•­ 1] - ì•¼ê°„ í‘œì‹œ(ë°°ê²½)ëŠ” í•­ìƒ ë¡œí…Œì´ì…˜ ê²°ê³¼ë¡œ ê²°ì •
                    
                    dayCell.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-status" style="color:${isNightShift ? 'var(--color-secondary)' : 'var(--color-primary)'};">${dayStatusText}</div>
                        <div class="day-overtime">${overtimeText}</div>
                    `;
                    dayCell.onclick = () => openWorkRecordModal(dateStr);
                    grid.appendChild(dayCell);
                }

                const totalCells = firstDayOfWeek + daysInMonth;
                const nextMonthFill = (totalCells > 35) ? (42 - totalCells) : (35 - totalCells);
                for (let i = 0; i < nextMonthFill; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell disabled';
                    dayCell.innerHTML = `<div class="day-number">${i + 1}</div><div class="day-status"></div><div class="day-overtime"></div>`;
                    grid.appendChild(dayCell);
                }
                calendarView.appendChild(monthElement);
            });

            calendarView.removeEventListener('scroll', updateActiveMonth);
            calendarView.addEventListener('scroll', updateActiveMonth);
            if (scrollToToday && lastScrollMonthId) scrollToTodayMonth(lastScrollMonthId);
            loadPeriodSettingsToUI();
        }

        function loadPeriodSettingsToUI() {
            const currentKey = getCurrentActivePeriodKey();
            if (currentKey) {
                const period = getSalaryPeriodByPeriodKey(currentKey);
                if (period) {
                    document.getElementById('salary-period-info').textContent = `ì´ ì˜ˆìƒ ì›”ê¸‰ (${formatDate(period.startDate)} ~ ${formatDate(period.endDate)})`;
                }
                document.getElementById('base-pay').value = USER_DATA.settings.basePays[currentKey] || 0;
                document.getElementById('regular-pay-check').checked = USER_DATA.settings.regularPayChecks[currentKey] || false;
                renderAdditionalItems(currentKey);
                updateSalary();
                document.querySelectorAll('.calendar-month').forEach(monthEl => {
                    monthEl.classList.remove('active');
                    const rect = monthEl.getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < 300) monthEl.classList.add('active');
                });
            } else {
                document.getElementById('salary-period-info').textContent = 'ì´ ì˜ˆìƒ ì›”ê¸‰ (ë¡œë”© ì¤‘...)';
                document.getElementById('total-expected-salary').textContent = '0 ì›';
                document.getElementById('base-pay').value = '';
                document.getElementById('regular-pay-check').checked = false;
                renderAdditionalItems(null);
            }
        }

        function updateActiveMonth() {
            if (window.activeMonthTimeout) clearTimeout(window.activeMonthTimeout);
            window.activeMonthTimeout = setTimeout(() => {
                const months = document.querySelectorAll('.calendar-month');
                let newActiveMonthElement = null;
                 for (let i = 0; i < months.length; i++) {
                     const month = months[i];
                     const rect = month.getBoundingClientRect();
                     if (rect.top >= 0 && rect.top < 300) { newActiveMonthElement = month; break; }
                 }
                 months.forEach(m => m.classList.remove('active'));
                 if (newActiveMonthElement) newActiveMonthElement.classList.add('active');
                loadPeriodSettingsToUI();
            }, 100);
        }
        
        function openWorkRecordModal(dateStr) {
            const dateCell = document.querySelector(`.day-cell[onclick*="${dateStr}"]`);
            if (dateCell && dateCell.classList.contains('disabled')) return;
            
            const modal = document.getElementById('work-record-modal');
            document.getElementById('modal-date-title').textContent = `${dateStr} ê·¼ë¬´ ê¸°ë¡`;
            document.getElementById('modal-selected-date').value = dateStr;
            document.getElementById('delete-record-btn').style.display = 'none';

            document.querySelectorAll('input[name="work-type"]').forEach(input => input.checked = false);
            document.getElementById('modal-overtime-list').innerHTML = '';

            const workRecord = USER_DATA.workRecords[dateStr];
            if (workRecord) {
                const typeInput = document.getElementById(`type-${workRecord.type}`);
                if (typeInput) typeInput.checked = true;
                if (workRecord.overtimes && workRecord.overtimes.length > 0) {
                    workRecord.overtimes.forEach(ot => addOvertimeRow(false, ot.name, ot.time));
                }
                document.getElementById('delete-record-btn').style.display = 'inline-block';
            } else {
                document.getElementById('type-ë¯¸ì„ íƒ').checked = true;
            }
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function saveWorkRecord() {
            const dateStr = document.getElementById('modal-selected-date').value;
            const selectedType = document.querySelector('input[name="work-type"]:checked');
            if (!selectedType) { alert("ê·¼ë¬´ í˜•íƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const type = selectedType.value;
            const overtimes = [];
            document.querySelectorAll('#modal-overtime-list .overtime-input-row').forEach(row => {
                const nameSelect = row.querySelector('select');
                const timeInput = row.querySelector('input[type="number"]');
                // [ìˆ˜ì •ì‚¬í•­ 2] - ì”ì—… ì…ë ¥ ì—†ì´ ìë™ ì ìš©ë˜ë¯€ë¡œ, 0h ì”ì—…ë„ ì €ì¥í•˜ë„ë¡ í—ˆìš© (ë‹¤ë§Œ, timeì´ 0ë³´ë‹¤ í¬ì§€ ì•Šë‹¤ëŠ” ê¸°ì¡´ ë¡œì§ì€ ìœ ì§€)
                if (nameSelect && nameSelect.value && timeInput) {
                    // timeInputì´ readonlyì´ê³  ê°’ì´ 0.0h ì´ìƒì´ë©´ ì €ì¥
                    if (Number(timeInput.value) >= 0) { 
                       overtimes.push({ name: nameSelect.value, time: Number(timeInput.value) });
                    }
                }
            });

            USER_DATA.workRecords[dateStr] = { date: dateStr, type: type, overtimes: overtimes };
            saveData();
            generateCalendar(); 
            closeModal('work-record-modal');
        }

        function deleteWorkRecord() {
            const dateStr = document.getElementById('modal-selected-date').value;
            if (confirm(`${dateStr}ì˜ ê·¼ë¬´ ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                delete USER_DATA.workRecords[dateStr];
                saveData();
                generateCalendar();
                closeModal('work-record-modal');
            }
        }
        
        function addOvertimeRow(isNew, name = '', time = '') {
            const container = document.getElementById('modal-overtime-list');
            const overtimeSettingList = USER_DATA.settings.overtimeList;
            if (overtimeSettingList.length === 0) {
                 container.innerHTML = `<small style="color:var(--color-error);">ì„¤ì • íƒ­ì—ì„œ ì”ì—… ì¢…ë¥˜ë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.</small>`;
                 return;
            }

            const row = document.createElement('div');
            row.className = 'overtime-input-row';
            row.innerHTML = `
                <select>
                    <option value="">--- ì„ íƒ ---</option>
                    ${overtimeSettingList.map(item => `<option value="${item.name}" ${item.name === name ? 'selected' : ''}>${item.name} (${item.time}h)</option>`).join('')}
                </select>
                <input type="number" step="0.5" placeholder="ì‹œê°„" value="${time}" readonly>
                <button onclick="this.parentNode.remove()" style="background:none; border:none; color:var(--color-error); font-size:1.2em; padding:0; cursor:pointer;">&times;</button>
            `;
            row.querySelector('select').addEventListener('change', function() {
                const selectedItem = overtimeSettingList.find(item => item.name === this.value);
                const timeInput = row.querySelector('input[type="number"]');
                // readonly ì†ì„±ì´ ìˆìœ¼ë¯€ë¡œ, select ë³€ê²½ ì‹œ ê°’ì„ ìë™ìœ¼ë¡œ ì„¤ì •ë§Œ í•´ ì¤ë‹ˆë‹¤.
                if (selectedItem) timeInput.value = selectedItem.time > 0 ? selectedItem.time : 0; // 0.0hë„ ìë™ ì„¤ì •
                else timeInput.value = '';
            });
            container.appendChild(row);
        }

        function autoSetOvertime(event) {
            const selectedType = event.target.value;
            const overtimeContainer = document.getElementById('modal-overtime-list');
            // 'ê¸°ë³¸ ì”ì—…' ì‹œê°„ì€ USER_DATA.settings.overtimeList ì— 0.0hë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë‚˜, 
            // ìš”ì²­ì— ë”°ë¼ ìë™ ì ìš©ë˜ëŠ” ì‹œê°„ì„ ì—¬ê¸°ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
            const defaultOvertimeMap = { 'ì£¼ê°„': 3.0, 'ì•¼ê°„': 4.5, 'ì£¼ê°„íŠ¹ê·¼': 0.5, 'ì•¼ê°„íŠ¹ê·¼': 7.0, '17ì‹œí‡´ê·¼': 0.5 };
            const defaultTime = defaultOvertimeMap[selectedType];
            overtimeContainer.innerHTML = ''; // ê¸°ì¡´ ì”ì—… ì´ˆê¸°í™”
            // [ìˆ˜ì •ì‚¬í•­ 2] - 'ê¸°ë³¸ ì”ì—…' ì´ë¦„ê³¼ ìë™ ì ìš© ì‹œê°„ì„ ë„£ì–´ í–‰ì„ ì¶”ê°€
            if (defaultTime) addOvertimeRow(false, 'ê¸°ë³¸ ì”ì—…', defaultTime);
        }

        // --- ê¸°íƒ€ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ ---
        function toggleSalaryDetails() {
            const section = document.getElementById('salary-input-section');
            const details = document.getElementById('salary-details-container');
            const toggleBtn = document.getElementById('toggle-salary-details');
            const isCollapsed = section.classList.toggle('collapsed');
            details.classList.toggle('collapsed');
            USER_DATA.settings.isSalaryDetailsCollapsed = isCollapsed;
            toggleBtn.textContent = isCollapsed ? 'â–²' : 'â–¼';
            saveData();
        }

        function copyPreviousMonthBasePay() {
            const currentKey = getCurrentActivePeriodKey();
            if (!currentKey) return;
            const prevKey = getPreviousPeriodKey(currentKey);
            const prevBasePay = USER_DATA.settings.basePays[prevKey] || 0;
            if (prevBasePay) {
                document.getElementById('base-pay').value = prevBasePay;
                saveBasePaySetting();
                alert(`ì´ì „ ë‹¬ ê¸°ë³¸ê¸‰ (${prevBasePay.toLocaleString()} ì›)ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.`);
            } else {
                alert("ì´ì „ ë‹¬ì˜ ê¸°ë³¸ê¸‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        function addAdditionalItem(name = '', amount = '') {
            const container = document.getElementById('additional-items-list');
            const div = document.createElement('div');
            div.innerHTML = `
                <input type="text" placeholder="ìˆ˜ë‹¹ ì´ë¦„ (ì˜ˆ: ìƒì—¬ê¸ˆ)" value="${name}" oninput="saveAdditionalItems()">
                <input type="number" placeholder="ê¸ˆì•¡" value="${amount}" oninput="saveAdditionalItems()">
                <button onclick="this.parentNode.remove(); saveAdditionalItems(); updateSalary();" style="background: none; border: none; color: var(--color-error); padding: 5px; font-size: 1.2em; cursor: pointer;">&times;</button>
            `;
            container.appendChild(div);
        }

        function renderAdditionalItems(periodKey) {
            const container = document.getElementById('additional-items-list');
            container.innerHTML = '';
            if (!periodKey) return;
            const items = USER_DATA.settings.additionalItemsByPeriod[periodKey] || [];
            items.forEach(item => addAdditionalItem(item.name, item.amount));
        }

        function saveAdditionalItems() {
            const currentKey = getCurrentActivePeriodKey();
            if (!currentKey) return;
            const items = [];
            document.querySelectorAll('#additional-items-list > div').forEach(div => {
                const nameInput = div.querySelector('input[type="text"]');
                const amountInput = div.querySelector('input[type="number"]');
                if (nameInput && amountInput && nameInput.value) {
                    items.push({ name: nameInput.value, amount: Number(amountInput.value) || 0 });
                }
            });
            USER_DATA.settings.additionalItemsByPeriod[currentKey] = items;
            saveData();
            updateSalary();
        }
        
        // --- ê¸‰ì—¬ ë° í†µê³„ ê³„ì‚° ---
        
        /**
         * BUGFIX: ê¸‰ì—¬ ê³„ì‚° ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± ë†’ì„
         * @param {string} periodKey - 'YYYY-MM' í˜•ì‹ì˜ ê¸‰ì—¬ ê¸°ê°„ í‚¤
         * @returns {object} - í•´ë‹¹ ê¸°ê°„ì˜ ê³„ì‚°ëœ í†µê³„ ì •ë³´
         */
        function calculatePeriodStats(periodKey) {
            const stats = {
                totalSalary: 0, nightDays: 0, specialDays: 0, vacationDays: 0,
                weekdayOT: 0, specialOT: 0, nightAmount: 0, specialAmount: 0,
                weekdayOTAmount: 0, specialOTAmount: 0, basePay: 0
            };

            const period = getSalaryPeriodByPeriodKey(periodKey);
            if (!period) return stats;

            stats.basePay = USER_DATA.settings.basePays[periodKey] || 0;
            const isRegularPayChecked = USER_DATA.settings.regularPayChecks[periodKey] || false;
            const additionalItems = USER_DATA.settings.additionalItemsByPeriod[periodKey] || [];
            
            const standardMonthlyHours = 209;
            const hourlyWage = stats.basePay > 0 ? stats.basePay / standardMonthlyHours : 0;
            let regularHourlyWage = hourlyWage;

            let tempDate = new Date(period.startDate);
            tempDate.setHours(0, 0, 0, 0); 

            while (tempDate <= period.endDate) {
                const dateStr = formatDate(tempDate);
                const workRecord = USER_DATA.workRecords[dateStr];
                
                if (workRecord && workRecord.type !== 'ë¯¸ì„ íƒ') {
                    const finalWorkType = workRecord.type;
                    let isHolidayDay = isHoliday(tempDate) || tempDate.getDay() === 0;

                    if (finalWorkType.includes('ì•¼ê°„')) stats.nightDays++;
                    if (finalWorkType.includes('íŠ¹ê·¼')) stats.specialDays++;
                    if (finalWorkType === 'íœ´ê°€') stats.vacationDays++;
                    else if (finalWorkType === 'ë°˜ì°¨') stats.vacationDays += 0.5;

                    if (workRecord.overtimes) {
                        const totalOvertime = calculateTotalOvertime(workRecord.overtimes);
                        if (totalOvertime > 0) {
                            if (finalWorkType.includes('íŠ¹ê·¼') || isHolidayDay) {
                                stats.specialOT += totalOvertime;
                            } else {
                                stats.weekdayOT += totalOvertime;
                            }
                        }
                    }
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            stats.weekdayOTAmount = stats.weekdayOT * regularHourlyWage * 1.5;
            stats.specialOTAmount = stats.specialOT * regularHourlyWage * 2.0;
            stats.nightAmount = stats.nightDays * regularHourlyWage * 8 * 0.5;
            
            const totalAdditionalAmount = additionalItems.reduce((sum, item) => sum + item.amount, 0);
            
            stats.totalSalary = stats.basePay + stats.weekdayOTAmount + stats.specialOTAmount + stats.nightAmount + totalAdditionalAmount;
            
            return stats;
        }


        function updateSalary() {
            const currentKey = getCurrentActivePeriodKey();
            if (!currentKey) {
                document.getElementById('total-expected-salary').textContent = '0 ì›';
                return;
            }
            
            const stats = calculatePeriodStats(currentKey);
            const isRegularPayChecked = USER_DATA.settings.regularPayChecks[currentKey] || false;
            const hourlyWage = stats.basePay > 0 ? stats.basePay / 209 : 0;

            document.getElementById('total-expected-salary').textContent = Math.round(stats.totalSalary).toLocaleString() + ' ì›';
            
            /**
             * BUGFIX: ê¸°ë³¸ê¸‰ í‘œì‹œ ì œê±°
             */
            document.getElementById('current-salary-options').textContent = 
                `ì‹œê¸‰: ${hourlyWage.toLocaleString(undefined, { maximumFractionDigits: 0 })}ì› | í†µìƒì„ê¸ˆ í¬í•¨: ${isRegularPayChecked ? 'O' : 'X'}`;
            
            document.getElementById('stat-weekday-ot-time-count').textContent = stats.weekdayOT.toFixed(1) + 'h';
            document.getElementById('stat-weekday-ot-time-amount').textContent = Math.round(stats.weekdayOTAmount).toLocaleString() + ' ì›';

            document.getElementById('stat-special-ot-time-count').textContent = stats.specialOT.toFixed(1) + 'h';
            document.getElementById('stat-special-ot-time-amount').textContent = Math.round(stats.specialOTAmount).toLocaleString() + ' ì›';

            document.getElementById('stat-special-day-count-count').textContent = stats.specialDays + 'ì¼';
            document.getElementById('stat-special-day-count-amount').textContent = Math.round(stats.specialAmount).toLocaleString() + ' ì›';

            document.getElementById('stat-night-day-count-count').textContent = stats.nightDays + 'ì¼';
            document.getElementById('stat-night-day-count-amount').textContent = Math.round(stats.nightAmount).toLocaleString() + ' ì›';
        }

        /**
         * BUGFIX: í†µê³„ íƒ­ ë…„ë„ í•„í„° ì±„ìš°ê¸° ë° ë Œë”ë§ ê¸°ëŠ¥ êµ¬í˜„
         */
        function populateStatsFilter() {
            const yearFilter = document.getElementById('stats-year-filter');
            const existingYears = new Set();
            Object.keys(USER_DATA.settings.basePays).forEach(periodKey => {
                existingYears.add(periodKey.substring(0, 4));
            });

            const currentYear = new Date().getFullYear();
            existingYears.add(currentYear.toString());

            const sortedYears = Array.from(existingYears).sort((a, b) => b - a);
            
            yearFilter.innerHTML = '';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}ë…„`;
                yearFilter.appendChild(option);
            });
             if (yearFilter.value != currentYear) {
                yearFilter.value = currentYear;
            }
        }


        function renderStatistics() {
            // [ìˆ˜ì •ì‚¬í•­ 3] - ì›” í•„í„° ê°’ ì½ê¸°
            const yearFilter = document.getElementById('stats-year-filter');
            const monthFilter = document.getElementById('stats-month-filter');
            const selectedYear = yearFilter.value;
            const selectedMonth = Number(monthFilter.value); // 0: ì „ì²´ ì›”
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            let totalSalary = 0; // ë…„ë„ë³„ í•©ê³„ ëŒ€ì‹  ì¡°íšŒ ê¸°ê°„ í•©ê³„ë¡œ ë³€ê²½

            const startMonth = selectedMonth === 0 ? 1 : selectedMonth;
            const endMonth = selectedMonth === 0 ? 12 : selectedMonth;

            for (let month = startMonth; month <= endMonth; month++) {
                const periodKey = `${selectedYear}-${String(month).padStart(2, '0')}`;
                const stats = calculatePeriodStats(periodKey);

                if (stats.basePay > 0 || stats.totalSalary > 0) { // ë°ì´í„°ê°€ ìˆëŠ” ì›”ë§Œ í‘œì‹œ
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${selectedYear}ë…„ ${month}ì›”</td>
                        <td>${Math.round(stats.totalSalary).toLocaleString()} ì›</td>
                        <td>${stats.nightDays}ì¼</td>
                        <td>${stats.specialDays}ì¼</td>
                        <td>${stats.vacationDays}ì¼</td>
                    `;
                    tableBody.appendChild(row);
                    totalSalary += stats.totalSalary;
                }
            }
            
            // [ìˆ˜ì •ì‚¬í•­ 3] - ì¡°íšŒ ê¸°ê°„ì— ë”°ë¥¸ í•©ê³„ í…ìŠ¤íŠ¸ ë³€ê²½
            const summaryText = selectedMonth === 0 ? 'ì´ í•©ê³„' : `${selectedMonth}ì›” í•©ê³„`;
            document.getElementById('stats-total-sum').textContent = `${summaryText}: ${Math.round(totalSalary).toLocaleString()} ì›`;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            
            if (tabName === 'statistics') {
                populateStatsFilter();
                renderStatistics();
            } else if (tabName === 'calendar') {
                loadPeriodSettingsToUI();
            }
        }

        function renderCustomHolidays() {
            const container = document.getElementById('custom-holidays-list');
            container.innerHTML = '';
            USER_DATA.settings.customHolidays.forEach(holiday => addCustomHolidayInput(holiday.date, holiday.name));
        }

        function addCustomHolidayInput(date = '', name = '') {
             const container = document.getElementById('custom-holidays-list');
             const div = document.createElement('div');
             div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 5px;';
             div.innerHTML = `
                 <input type="date" value="${date}" onchange="saveCustomHolidays()">
                 <input type="text" placeholder="ê³µíœ´ì¼ ì´ë¦„" value="${name}" oninput="saveCustomHolidays()">
                 <button onclick="this.parentNode.remove(); saveCustomHolidays(); generateCalendar();" style="background: none; border: none; color: var(--color-error); padding: 5px; font-size: 1.2em; cursor: pointer;">&times;</button>
             `;
             container.appendChild(div);
        }

        function saveCustomHolidays() {
             const holidays = [];
             document.querySelectorAll('#custom-holidays-list > div').forEach(div => {
                 const dateInput = div.querySelector('input[type="date"]');
                 const nameInput = div.querySelector('input[type="text"]');
                 if (dateInput && dateInput.value) holidays.push({ date: dateInput.value, name: nameInput.value || 'ì‚¬ìš©ì ì§€ì • ê³µíœ´ì¼' });
             });
             USER_DATA.settings.customHolidays = holidays;
             saveData();
             generateCalendar();
        }

        function renderOvertimeSettings() {
             const container = document.getElementById('overtime-list-container');
             container.innerHTML = '';
             USER_DATA.settings.overtimeList.forEach(item => addOvertimeSettingItem(item.name, item.time));
        }

        /**
         * BUGFIX: ëª¨ë“  ì”ì—… í•­ëª©ì— ì‚­ì œ ë²„íŠ¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ë„ë¡ ë³´ì¥
         */
        function addOvertimeSettingItem(name = '', time = 0.5) {
             const container = document.getElementById('overtime-list-container');
             const div = document.createElement('div');
             div.innerHTML = `
                 <input type="text" placeholder="ì”ì—… ì´ë¦„ (ì˜ˆ: G1ì¡°ì¶œ)" value="${name}" oninput="saveOvertimeSettings()">
                 <input type="number" step="0.5" placeholder="ê¸°ë³¸ ì‹œê°„(h)" value="${time}" oninput="saveOvertimeSettings()">
                 <button onclick="this.parentNode.remove(); saveOvertimeSettings();" style="background: none; border: none; color: var(--color-error); padding: 5px; font-size: 1.2em; cursor: pointer;">&times;</button>
             `;
             container.appendChild(div);
        }

        function saveOvertimeSettings() {
             const overtimeList = [];
             document.querySelectorAll('#overtime-list-container > div').forEach(div => {
                 const nameInput = div.querySelector('input[type="text"]');
                 const timeInput = div.querySelector('input[type="number"]');
                 if (nameInput && nameInput.value) overtimeList.push({ name: nameInput.value, time: Number(timeInput.value) || 0.0 });
             });
             USER_DATA.settings.overtimeList = overtimeList;
             saveData();
        }

        function renderClassChangeHistory() {
             const container = document.getElementById('class-change-history-list');
             container.innerHTML = '';
             USER_DATA.settings.classChangeHistory.forEach(record => addClassChangeRecordInput(record.changeDate, record.newClass));
        }

        function addClassChangeRecordInput(date = '', newClass = USER_DATA.class) {
             const container = document.getElementById('class-change-history-list');
             const div = document.createElement('div');
             div.className = 'change-record-row';
             div.innerHTML = `
                 <input type="date" value="${date}" onchange="saveClassChangeHistory()">
                 <select onchange="saveClassChangeHistory()">
                     <option value="A" ${newClass === 'A' ? 'selected' : ''}>Aë°˜</option>
                     <option value="B" ${newClass === 'B' ? 'selected' : ''}>Bë°˜</option>
                     <option value="C" ${newClass === 'C' ? 'selected' : ''}>Cë°˜</option>
                     <option value="D" ${newClass === 'D' ? 'selected' : ''}>Dë°˜</option>
                 </select>
                 <button onclick="this.parentNode.remove(); saveClassChangeHistory(); generateCalendar();" style="background: none; border: none; color: var(--color-error); padding: 5px; font-size: 1.2em; cursor: pointer;">&times;</button>
             `;
             container.appendChild(div);
        }

        function saveClassChangeHistory() {
             const history = [];
             document.querySelectorAll('#class-change-history-list > div').forEach(div => {
                 const dateInput = div.querySelector('input[type="date"]');
                 const classSelect = div.querySelector('select');
                 if (dateInput && dateInput.value && classSelect) history.push({ changeDate: dateInput.value, newClass: classSelect.value });
             });
             USER_DATA.settings.classChangeHistory = history;
             saveData();
             generateCalendar();
        }

        function backupData() {
            const dataStr = JSON.stringify(USER_DATA, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smartSalaryApp_backup_${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("ë°ì´í„°ê°€ ë°±ì—… íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function restoreData(event) {
             const file = event.target.files[0];
             if (!file) return;
             if (!confirm("í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  ë°±ì—… íŒŒì¼ë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { event.target.value = ''; return; }
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const restoredData = JSON.parse(e.target.result);
                     if (!restoredData.account || !restoredData.workRecords) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤.");
                     localStorage.setItem('smartSalaryApp_user_data', JSON.stringify(restoredData));
                     alert("ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.");
                     window.location.reload(); 
                 } catch (error) {
                     console.error("ë³µêµ¬ ì˜¤ë¥˜:", error);
                     alert(`ë°ì´í„° ë³µêµ¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                 } finally {
                     event.target.value = '';
                 }
             };
             reader.readAsText(file);
        }

        function resetAllData() {
            // [ìˆ˜ì •ì‚¬í•­ 4] - ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” ë²„íŠ¼: ë¡œì§ì€ ì´ë¯¸ ì˜¬ë°”ë¥´ë¯€ë¡œ ìœ ì§€.
            if (confirm("ê²½ê³ : ëª¨ë“  ì €ì¥ëœ ë°ì´í„°(ê·¼ë¬´ ê¸°ë¡, ì„¤ì • ë“±)ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('smartSalaryApp_user_data');
                alert("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.");
                window.location.reload();
            }
        }

        function toggleTheme(isLightMode) {
             USER_DATA.settings.isLightMode = isLightMode;
             saveData();
             applyTheme(isLightMode);
        }

        function applyTheme(isLightMode) {
             if (isLightMode) document.documentElement.classList.add('light-mode');
             else document.documentElement.classList.remove('light-mode');
        }

        function scrollToTodayMonth(targetMonthId = null) {
             const today = new Date();
             const todayMonthId = targetMonthId || `month-${today.getFullYear()}-${today.getMonth()}`;
             const todayMonthElement = document.getElementById(todayMonthId);
             if (todayMonthElement) {
                  todayMonthElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  setTimeout(() => { loadPeriodSettingsToUI(); }, 500);
             }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tab-calendar').addEventListener('click', () => switchTab('calendar'));
            document.getElementById('tab-statistics').addEventListener('click', () => switchTab('statistics'));
            document.getElementById('tab-settings').addEventListener('click', () => switchTab('settings'));
            document.getElementById('today-button').addEventListener('click', () => scrollToTodayMonth());
            document.getElementById('work-type-group').addEventListener('change', autoSetOvertime);
            loadData();
        });

    </script>

</body>
</html>
