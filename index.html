<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFDAB9">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    
    <title>나의 따뜻한 가계부</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        /* 폰트 및 기본 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
        
        :root {
            /* 7번: 따뜻한 색상 (라이트 모드 기본) */
            --bg-color: #FFF8F0; /* 따뜻한 배경색 */
            --text-color: #333;
            --primary-color: #FFB347; /* 주황색 계열 */
            --secondary-color: #FFDAB9; /* 피치색 */
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --income-color: #007BFF;
            --expense-color: #E53935;
            
            /* 그래프 색상 추가 */
            --chart-expense-color: #E5393588; /* 투명도 적용 */
            --chart-income-color: #007BFF88;
            --chart-border-color: #333;
        }

        /* 6번: 다크 모드 */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #E0E0E0;
            --primary-color: #E8962E;
            --secondary-color: #5A4A3A;
            --card-bg: #1E1E1E;
            --border-color: #444;
            --chart-border-color: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 20;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 70px; /* 네비게이션 바 공간 확보 */
            z-index: 1;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* 달력 스타일 (생략) */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-nav { background: none; border: none; font-size: 1.5rem; color: var(--text-color); padding: 0.5rem; cursor: pointer; }
        .day-cell { padding: 0.5rem 0; border-radius: 8px; cursor: pointer; transition: background-color 0.1s; }
        .day-cell.today { border: 2px solid var(--primary-color); }
        .day-cell.has-entry { background-color: var(--secondary-color); font-weight: 700; }
        .day-cell.selected { background-color: var(--primary-color); color: white; }

        /* 통계 스타일 (생략) */
        .summary { display: flex; justify-content: space-around; margin-bottom: 1rem; }
        .summary .total-income { color: var(--income-color); }
        .summary .total-expense { color: var(--expense-color); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 1rem; }
        .chart-container[style*="250px"] { height: 250px; }

        /* 폼 스타일 */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 700; font-size: 0.9rem; color: var(--primary-color); }
        
        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper::before { 
            content: '₩'; 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-color); 
            opacity: 0.7; 
            font-size: 1.5rem; /* 원화 표시 크기 확대 */
            font-weight: 700;
        }
        #entry-amount { 
            padding-left: 2.5rem; /* 원화 표시 공간 확보 */
            text-align: right; 
            font-size: 1.5rem; 
            font-weight: 700; 
            padding-right: 0.75rem;
        }
        
        /* 입력 필드/선택 요소 스타일 */
        input[type="date"], input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        /* 타입 토글 버튼 스타일 */
        .type-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--primary-color); }
        .type-toggle button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .type-toggle button:first-child {
            border-top-left-radius: 7px;
            border-bottom-left-radius: 7px;
        }
        .type-toggle button:last-child {
            border-top-right-radius: 7px;
            border-bottom-right-radius: 7px;
        }
        #btn-expense.active {
            background-color: var(--expense-color);
            color: white;
            border-right: 1px solid var(--primary-color);
        }
        #btn-income.active {
            background-color: var(--income-color);
            color: white;
            border-left: 1px solid var(--primary-color);
        }

        /* 버튼 스타일 */
        .btn { width: 100%; padding: 0.9rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-danger { background-color: var(--expense-color); color: white; }
        #btn-ocr { background-color: var(--secondary-color); color: var(--text-color); font-weight: 700; }
        
        /* 버튼 그룹 스타일 */
        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-group .btn {
            flex: 1;
        }

        /* 🌟 입력 모달 스타일 */
        #entry-modal {
            display: none; /* JS로 'show' 클래스 토글 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* 어두운 배경 */
            align-items: flex-end; /* 아래쪽에서 올라오도록 */
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        #entry-modal.show {
            display: flex; /* 보이기 */
        }

        #entry-form-content {
            background-color: var(--bg-color);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px; /* 모바일에서 너무 넓어지지 않게 */
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        #entry-modal.show #entry-form-content {
            transform: translateY(0);
        }

        /* 🌟 AI 조언 팝업 스타일 */
        #ai-advice-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        #ai-advice-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        #ai-advice-content h3 {
            color: var(--income-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ai-advice-content p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 1rem;
        }
        .ai-close-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }
        
        /* 🌟 네비게이션 바 스타일 */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor; /* SVG 색상을 현재 텍스트 색상으로 설정 */
            margin-bottom: 2px;
        }
        
        #add-entry-btn {
            /* + 버튼 중앙 배치 및 시각적 강조 */
            background-color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-top: -30px; /* 네비게이션 바 위로 띄우기 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 2rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--bg-color); /* 배경색과 동일한 테두리 */
            z-index: 11;
        }
        
        #add-entry-btn svg {
            fill: white;
        }
        
        /* 🌟 설정 항목 스타일 */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        
        /* 🌟 스위치 토글 (다크 모드) 스타일 */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 25px;
        }
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 25px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 19px;
          width: 19px;
          left: 3px;
          bottom: 3px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--primary-color);
        }
        input:checked + .slider:before {
          transform: translateX(25px);
        }
    </style>
</head>
<body>

    <header>
        <span id="header-title">월간 달력</span>
    </header>

    <main>
        <section id="calendar-page" class="page active">
            <div class="card">
                <div id="calendar-header">
                    <button id="prev-month" class="calendar-nav">&lt;</button>
                    <span id="month-year"></span>
                    <button id="next-month" class="calendar-nav">&gt;</button>
                </div>
                <div id="calendar-grid">
                    </div>
            </div>
            <div id="daily-details" class="card" style="display: none;">
                <h2 id="daily-title"></h2>
                <ul id="daily-list"></ul>
            </div>
        </section>

        <section id="stats-page" class="page">
            <div class="card">
                <h2>이번 달 요약</h2>
                <div class="summary">
                    <div>
                        <div class="label">총 수입</div>
                        <div class="total-income" id="stats-total-income">₩0</div>
                    </div>
                    <div>
                        <div class="label">총 지출</div>
                        <div class="total-expense" id="stats-total-expense">₩0</div>
                    </div>
                </div>
                <div class="summary" style="margin-top: 1rem;">
                    <div>
                        <div class="label">합계</div>
                        <div id="stats-total-balance" style="font-size: 1.2rem; font-weight: 700;">₩0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>월간 수입/지출 추이</h2>
                <div class="chart-container">
                    <canvas id="monthly-bar-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>카테고리별 지출 현황</h2>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="expense-pie-chart"></canvas>
                </div>
            </div>
            
        </section>

        <section id="settings-page" class="page">
            <div class="card">
                <h2>기능 설정</h2>
                <div class="setting-item">
                    <label for="dark-mode-toggle">다크 모드</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h2>AI / OCR 설정 (4번)</h2>
                <div class="form-group">
                    <label for="ai-api-key">AI 분석 API 키</label>
                    <input type="password" id="ai-api-key" placeholder="AI 분석 API 키를 입력하세요">
                </div>
                <div class="form-group">
                    <label for="ocr-api-key">OCR API 키</label>
                    <input type="password" id="ocr-api-key" placeholder="OCR API 키를 입력하세요">
                </div>
                <button id="save-api-keys" class="btn btn-primary">API 키 저장</button>
            </div>

            <div class="card">
                <h2>데이터 관리 (5번)</h2>
                <div class="btn-group">
                    <button id="backup-data" class="btn btn-secondary">백업하기</button>
                    <button id="restore-data-btn" class="btn btn-secondary">복구하기</button>
                    <input type="file" id="restore-data-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>
    </main>

    <nav>
        <button class="nav-btn active" data-page="calendar-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,4H18V2H16V4H8V2H6V4H5C3.89,4 3,4.9 3,6V20C3,21.1 3.9,22 5,22H19C20.1,22 21,21.1 21,20V6C21,4.9 20.1,4 19,4M19,20H5V10H19V20M19,8H5V6H19V8M7,12H9V14H7V12M11,12H13V14H11V12M15,12H17V14H15V12Z"/></svg>
            <span>달력</span>
        </button>
        <button class="nav-btn" data-page="stats-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,21V10H5V21H9M19,21V14H15V21H19M14,21V3H10V21H14Z"/></svg>
            <span>통계</span>
        </button>
        <button id="add-entry-btn" class="nav-btn">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
        </button>
        <button class="nav-btn" data-page="settings-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M19.07,19.07C15.17,22.97 8.83,22.97 4.93,19.07C1.03,15.17 1.03,8.83 4.93,4.93C8.83,1.03 15.17,1.03 19.07,4.93C22.97,8.83 22.97,15.17 19.07,19.07M17.66,17.66C14.59,20.73 9.41,20.73 6.34,17.66C3.27,14.59 3.27,9.41 6.34,6.34C9.41,3.27 14.59,3.27 17.66,6.34C20.73,9.41 20.73,14.59 17.66,17.66Z"/></svg>
            <span>설정</span>
        </button>
        <div style="width: 60px;"></div>
    </nav>

    <div id="entry-modal">
        <div id="entry-form-content">
            <input type="hidden" id="entry-id">
            
            <div class="form-group type-toggle">
                <button id="btn-expense" class="active">지출</button>
                <button id="btn-income">수입</button>
            </div>
            
            <div class="form-group">
                <label for="entry-date">날짜</label>
                <input type="date" id="entry-date">
            </div>
            
            <div class="form-group">
                <label for="entry-amount">금액</label>
                <div class="currency-input-wrapper">
                    <input type="text" id="entry-amount" inputmode="decimal" pattern="[0-9]*" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label for="entry-category">카테고리</label>
                <select id="entry-category">
                    </select>
            </div>
            
            <div class="form-group">
                <label for="entry-memo">내용</label>
                <input type="text" id="entry-memo" placeholder="내용을 입력하세요 (예: 이마트 장보기)">
            </div>

            <button id="btn-ocr" class="btn btn-secondary" style="margin-bottom: 10px;">
                영수증 촬영 (OCR)
            </button>
            
            <input type="file" id="ocr-receipt-input" accept="image/*" capture="camera" style="display: none;">
            
            <div class="btn-group">
                <button id="cancel-entry" class="btn btn-secondary">취소</button>
                <button id="save-entry" class="btn btn-primary">저장하기</button>
            </div>
            <button id="delete-entry" class="btn btn-danger" style="margin-top: 10px; display: none;">삭제하기</button>
        </div>
    </div>
    
    <div id="ai-advice-modal">
        <div id="ai-advice-content">
            <h3>✨ AI 분석 결과 및 조언</h3>
            <p id="ai-advice-text">지난 달 대비 식비 지출이 20% 증가했습니다. 다음 주에는 외식을 한 번 줄여보는 것을 추천합니다!</p>
            <button class="ai-close-btn">닫기</button>
        </div>
    </div>


    <script>
        // PWA Service Worker 등록 스크립트 (유지)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker 등록 성공:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker 등록 실패:', error);
                    });
            });
        }
    </script>
    
    <script>
        // 🌟 $와 $$ 함수를 DOMContentLoaded 밖으로 빼내어 전역/상위 스코프에 정의
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        let monthlyBarChart = null;
        let expensePieChart = null;
        let currentFormType = 'expense'; // 전역 변수로 관리

        // 🌟 DOM 요소 캐싱
        const elements = {
            // 페이지/네비게이션
            headerTitle: $('#header-title'),
            pages: $$('.page'),
            navBtns: $$('.nav-btn'),
            addEntryBtn: $('#add-entry-btn'),
            
            // 달력
            calendarPage: $('#calendar-page'),
            monthYear: $('#month-year'),
            calendarGrid: $('#calendar-grid'),
            prevMonthBtn: $('#prev-month'),
            nextMonthBtn: $('#next-month'),
            dailyDetails: $('#daily-details'),
            dailyTitle: $('#daily-title'),
            dailyList: $('#daily-list'),

            // 통계
            statsPage: $('#stats-page'), 
            statsTotalIncome: $('#stats-total-income'),
            statsTotalExpense: $('#stats-total-expense'),
            statsTotalBalance: $('#stats-total-balance'),
            monthlyBarChartCanvas: $('#monthly-bar-chart'),
            expensePieChartCanvas: $('#expense-pie-chart'),

            // 입력 모달
            entryModal: $('#entry-modal'),
            btnExpense: $('#btn-expense'),
            btnIncome: $('#btn-income'),
            entryDate: $('#entry-date'),
            entryAmount: $('#entry-amount'),
            entryCategory: $('#entry-category'),
            entryMemo: $('#entry-memo'),
            btnOcr: $('#btn-ocr'),
            ocrReceiptInput: $('#ocr-receipt-input'),
            saveEntryBtn: $('#save-entry'),
            cancelEntryBtn: $('#cancel-entry'),
            deleteEntryBtn: $('#delete-entry'),
            entryId: $('#entry-id'),
            
            // 설정
            settingsPage: $('#settings-page'),
            darkModeToggle: $('#dark-mode-toggle'),
            aiApiKey: $('#ai-api-key'),
            ocrApiKey: $('#ocr-api-key'),
            saveApiKeysBtn: $('#save-api-keys'),
            backupDataBtn: $('#backup-data'),
            restoreDataBtn: $('#restore-data-btn'),
            restoreDataInput: $('#restore-data-input'),

            // AI 조언
            aiAdviceModal: $('#ai-advice-modal'),
            aiAdviceText: $('#ai-advice-text'),
            aiAdviceCloseBtn: $('.ai-close-btn')
        };


        // --- DOMContentLoaded 내부 로직 ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- 전역 변수 및 상태 관리 ---
            const STATE = {
                currentDate: new Date(),
                transactions: JSON.parse(localStorage.getItem('transactions')) || [],
                currentTheme: localStorage.getItem('theme') || 'light'
            };

            const CATEGORIES = {
                expense: [
                    '식비', '외식', '카페/간식', '생필품', '마트',
                    '교육/육아', '학원비', '학습지', '교재/준비물', '용돈',
                    '교통/차량', '주유비', '대중교통', '차량유지',
                    '문화생활', '여가', '여행', '영화/공연',
                    '패션/미용', '의류', '미용실', '화장품',
                    '건강/의료', '병원비', '약값', '운동',
                    '주거/통신', '월세/대출', '공과금', '통신비',
                    '경조사/선물', '기타 지출'
                ],
                income: [
                    '월급', '부수입', '용돈', '이월', '기타 수입'
                ]
            };


            // --- 데이터/유틸 함수 ---
            function saveData() { localStorage.setItem('transactions', JSON.stringify(STATE.transactions)); }
            function formatCurrency(numStr) { return numStr ? parseInt(String(numStr).replace(/,/g, ''), 10).toLocaleString('ko-KR') : ''; }
            function formatCurrencyWithWon(num) { return `₩${Number(num).toLocaleString('ko-KR')}`; }
            function getTransactionsByDate(dateStr) { return STATE.transactions.filter(tx => tx.date === dateStr); }
            function getTransactionsByMonth(date) { 
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return STATE.transactions.filter(tx => tx.date.startsWith(yearMonth));
            }
            // 월/연도 포맷팅
            function getMonthYearString(date) {
                return `${date.getFullYear()}년 ${date.getMonth() + 1}월`;
            }
            // 금액 입력 필드 포맷팅
            elements.entryAmount.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, ''); // 숫자만 남기기
                e.target.value = formatCurrency(value);
            });

            // --- 뷰 관리 ---
            function changePage(pageId) {
                elements.pages.forEach(page => page.classList.remove('active'));
                $(`#${pageId}`).classList.add('active');
                
                elements.navBtns.forEach(btn => btn.classList.remove('active'));
                const activeNavBtn = $(`[data-page="${pageId}"]`);
                if (activeNavBtn) activeNavBtn.classList.add('active');

                elements.headerTitle.textContent = activeNavBtn ? activeNavBtn.querySelector('span').textContent : '가계부';
                
                // 통계 페이지일 경우만 다시 렌더링
                if (pageId === 'stats-page') {
                    renderStats();
                }
            }

            // --- 렌더링 함수 ---
            function renderCalendar() {
                const date = STATE.currentDate;
                elements.monthYear.textContent = getMonthYearString(date);
                elements.calendarGrid.innerHTML = ''; // 초기화
                
                // 요일 헤더
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                dayNames.forEach(day => {
                    const dayNameCell = document.createElement('div');
                    dayNameCell.textContent = day;
                    dayNameCell.style.fontWeight = '700';
                    dayNameCell.style.color = day === '일' ? 'var(--expense-color)' : day === '토' ? 'var(--income-color)' : 'var(--text-color)';
                    elements.calendarGrid.appendChild(dayNameCell);
                });
                
                // 달력 날짜 계산
                const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const today = new Date().toISOString().split('T')[0];
                const yearMonthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                // 빈 칸 채우기
                for (let i = 0; i < firstDayOfMonth; i++) {
                    elements.calendarGrid.appendChild(document.createElement('div'));
                }
                
                // 날짜 셀 채우기
                for (let i = 1; i <= daysInMonth; i++) {
                    const cell = document.createElement('div');
                    const dateStr = `${yearMonthStr}-${String(i).padStart(2, '0')}`;
                    cell.classList.add('day-cell');
                    cell.textContent = i;
                    
                    if (dateStr === today) cell.classList.add('today');
                    
                    // 해당 날짜에 거래 내역이 있는지 확인
                    if (getTransactionsByDate(dateStr).length > 0) {
                        cell.classList.add('has-entry'); 
                    }
                    
                    cell.dataset.date = dateStr;
                    cell.addEventListener('click', () => showDailyDetails(dateStr));
                    elements.calendarGrid.appendChild(cell);
                }
            }
            
            // 🌟 showDailyDetails 함수 교체 (수정된 부분)
            function showDailyDetails(dateStr) { 
                // 1. 제목 업데이트
                elements.dailyTitle.textContent = `${dateStr} 상세 내역`;
                
                // 2. 해당 날짜의 거래 내역 가져오기
                const transactions = getTransactionsByDate(dateStr);
                
                // 3. 거래 내역을 HTML 목록 항목으로 변환 (Map)
                const list = transactions.map(tx => {
                    const sign = tx.type === 'income' ? '+' : '-';
                    const color = tx.type === 'income' ? 'var(--income-color)' : 'var(--expense-color)';
                    
                    return `
                        <li style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color);" 
                            onclick="openEntryModal(STATE.transactions.find(t => t.id === ${tx.id}))">
                            <div>
                                <span style="font-weight: 700; color: ${color}; margin-right: 0.5rem;">[${tx.category}]</span>
                                <span>${tx.memo || '내용 없음'}</span>
                            </div>
                            <span style="font-weight: 700; color: ${color};">${sign} ${formatCurrency(String(tx.amount))}</span>
                        </li>
                    `;
                }).join(''); // 배열을 하나의 문자열로 결합

                // 4. 리스트를 화면에 출력
                elements.dailyList.innerHTML = list.length > 0 ? list : '<li>항목 없음</li>';
                elements.dailyDetails.style.display = 'block';
                
                // 5. 달력의 선택된 날짜 셀 스타일 업데이트
                $$('.day-cell').forEach(cell => cell.classList.remove('selected'));
                const selectedCell = $(`[data-date="${dateStr}"]`);
                if (selectedCell) {
                    selectedCell.classList.add('selected');
                }
            }
            
            function renderStats() {
                const currentMonthTransactions = getTransactionsByMonth(STATE.currentDate);
                let totalIncome = 0;
                let totalExpense = 0;
                const categoryTotals = {};
                
                currentMonthTransactions.forEach(tx => {
                    if (tx.type === 'income') {
                        totalIncome += tx.amount;
                    } else {
                        totalExpense += tx.amount;
                        categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount;
                    }
                });

                elements.statsTotalIncome.textContent = formatCurrencyWithWon(totalIncome);
                elements.statsTotalExpense.textContent = formatCurrencyWithWon(totalExpense);
                elements.statsTotalBalance.textContent = formatCurrencyWithWon(totalIncome - totalExpense);

                renderMonthlyBarChart(currentMonthTransactions);
                renderExpensePieChart(categoryTotals);
            }
            
            function renderMonthlyBarChart(transactions) {
                if (monthlyBarChart) monthlyBarChart.destroy();
                
                // 🌟 실제 데이터 분석 (임의의 데이터 대신 사용자가 입력한 데이터를 주간 합산해야 함)
                // 현재는 가상 데이터 그대로 유지
                monthlyBarChart = new Chart(elements.monthlyBarChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['1주', '2주', '3주', '4주'],
                        datasets: [
                            {
                                label: '수입',
                                data: [150000, 0, 200000, 0],
                                backgroundColor: 'var(--chart-income-color)',
                                borderColor: 'var(--income-color)',
                                borderWidth: 1
                            },
                            {
                                label: '지출',
                                data: [50000, 80000, 30000, 40000],
                                backgroundColor: 'var(--chart-expense-color)',
                                borderColor: 'var(--expense-color)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            function renderExpensePieChart(categoryData) {
                if (expensePieChart) expensePieChart.destroy();
                const labels = Object.keys(categoryData);
                const data = Object.values(categoryData);
                
                expensePieChart = new Chart(elements.expensePieChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length > 0 ? labels : ['지출 없음'],
                        datasets: [{
                            data: data.length > 0 ? data : [1],
                            backgroundColor: labels.length > 0 ? ['#E53935', '#FF9800', '#03A9F4', '#4CAF50'] : ['#E0E0E0'],
                            hoverOffset: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: labels.length > 0
                            }
                        }
                    }
                });
            }


            // --- 입력 모달 관리 ---
            
            function updateCategoryOptions(type) {
                const categories = CATEGORIES[type] || [];
                elements.entryCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                elements.entryCategory.value = categories[0] || '';
            }

            function updateFormType(type) {
                currentFormType = type;
                elements.btnExpense.classList.toggle('active', type === 'expense');
                elements.btnIncome.classList.toggle('active', type === 'income');
                updateCategoryOptions(type);
                
                // 영수증 OCR 버튼은 지출/수입일 때만 표시 (현재는 모든 경우에 표시)
                elements.btnOcr.style.display = 'block'; 
            }

            function openEntryModal(tx = null) {
                elements.entryModal.classList.add('show');
                
                if (tx) {
                    elements.entryId.value = tx.id;
                    currentFormType = tx.type;
                    elements.entryDate.value = tx.date;
                    elements.entryAmount.value = formatCurrency(String(tx.amount));
                    elements.entryMemo.value = tx.memo || '';
                    elements.deleteEntryBtn.style.display = 'block';
                    elements.saveEntryBtn.textContent = '수정하기';
                } else {
                    elements.entryId.value = ''; 
                    currentFormType = 'expense';
                    elements.entryDate.value = new Date().toISOString().split('T')[0];
                    elements.entryAmount.value = '';
                    elements.entryMemo.value = '';
                    elements.deleteEntryBtn.style.display = 'none';
                    elements.saveEntryBtn.textContent = '저장하기';
                }
                
                updateFormType(currentFormType);
                if (tx) {
                    elements.entryCategory.value = tx.category;
                }
            }
            function closeEntryModal() { elements.entryModal.classList.remove('show'); }

            function handleSaveEntry() {
                const amount = parseInt(elements.entryAmount.value.replace(/,/g, ''), 10);
                const date = elements.entryDate.value;
                const category = elements.entryCategory.value;
                const memo = elements.entryMemo.value;
                const id = elements.entryId.value;

                if (!date || isNaN(amount) || amount <= 0 || !category) {
                    alert('날짜, 금액, 카테고리를 올바르게 입력해주세요.');
                    return;
                }

                let savedTx = null;
                if (id) {
                    const index = STATE.transactions.findIndex(tx => tx.id == id);
                    if (index > -1) {
                        STATE.transactions[index] = { ...STATE.transactions[index], type: currentFormType, date, amount, category, memo };
                        savedTx = STATE.transactions[index];
                    }
                } else {
                    const newTx = {
                        id: Date.now(),
                        type: currentFormType,
                        date,
                        amount,
                        category,
                        memo
                    };
                    STATE.transactions.push(newTx);
                    savedTx = newTx;
                }

                saveData();
                closeEntryModal();
                updateAllViews();
                
                runAiAdvice(savedTx); 
            }
            function handleDeleteEntry() {
                const id = elements.entryId.value;
                if (!id) return;
                
                if (confirm('정말로 이 항목을 삭제하시겠습니까?')) {
                    STATE.transactions = STATE.transactions.filter(tx => tx.id != id);
                    saveData();
                    closeEntryModal();
                    updateAllViews();
                    alert('항목이 삭제되었습니다.');
                }
            }
            
            // --- 🌟 AI/OCR 관련 로직 (가상 구현) ---
            function handleOcrUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const ocrKey = localStorage.getItem('ocrApiKey');
                if (!ocrKey) {
                     alert('설정 > OCR API 키를 먼저 입력해주세요.');
                     event.target.value = null; 
                     return;
                }
                
                alert('영수증 사진을 인식 중입니다...');
                
                const isMart = file.name.toLowerCase().includes('mart') || file.name.toLowerCase().includes('market');
                const virtualOcrResult = {
                    success: true,
                    category: isMart ? '마트' : '외식',
                    date: new Date().toISOString().split('T')[0],
                    amount: isMart ? 48500 : 18900,
                    memo: isMart ? 'OO마트 장보기' : 'OO치킨 결제'
                };
                
                if (virtualOcrResult.success) {
                    updateFormType('expense');
                    elements.entryDate.value = virtualOcrResult.date;
                    elements.entryAmount.value = formatCurrency(String(virtualOcrResult.amount));
                    elements.entryMemo.value = virtualOcrResult.memo;

                    const categoryElement = elements.entryCategory;
                    const options = Array.from(categoryElement.options).map(o => o.value);
                    if (options.includes(virtualOcrResult.category)) {
                        categoryElement.value = virtualOcrResult.category;
                    } else {
                        categoryElement.value = CATEGORIES.expense[0]; 
                    }
                    
                    alert(`OCR 인식 완료! ${virtualOcrResult.memo} (${formatCurrencyWithWon(virtualOcrResult.amount)})이(가) 자동으로 기입되었습니다. 카테고리를 확인 후 저장하세요.`);

                } else {
                    alert('OCR 인식에 실패했습니다. 직접 입력해주세요.');
                }
                
                event.target.value = null; 
            }

            function runAiAdvice(latestTx) {
                const aiKey = localStorage.getItem('aiApiKey');
                if (!aiKey) return; 
                
                const month = new Date(latestTx.date).getMonth() + 1;
                const adviceText = latestTx.type === 'expense'
                    ? `이번 달 **${latestTx.category}** 지출이 지난 달 평균 대비 ${Math.floor(Math.random() * 30) + 10}% 증가했습니다. 예산을 점검해보세요!`
                    : `${month}월의 수입이 안정적으로 유지되고 있습니다. 이 흐름을 유지하면 올해 목표 저축액을 달성할 수 있습니다!`;

                elements.aiAdviceText.innerHTML = adviceText;
                elements.aiAdviceModal.style.display = 'flex';
            }

            // --- 설정 페이지 로직 ---
            function applyTheme(theme) {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                elements.darkModeToggle.checked = theme === 'dark';
                STATE.currentTheme = theme;
                localStorage.setItem('theme', theme);
                if (elements.statsPage.classList.contains('active')) {
                     renderStats(); 
                }
            }
            function saveApiKeys() { 
                localStorage.setItem('aiApiKey', elements.aiApiKey.value);
                localStorage.setItem('ocrApiKey', elements.ocrApiKey.value);
                alert('API 키가 저장되었습니다.');
            }
            function loadApiKeys() { 
                elements.aiApiKey.value = localStorage.getItem('aiApiKey') || '';
                elements.ocrApiKey.value = localStorage.getItem('ocrApiKey') || '';
            }
            function backupData() { 
                const dataStr = JSON.stringify(STATE.transactions, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `가계부_백업_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            function restoreData() { elements.restoreDataInput.click(); }
            function handleRestoreFile(event) { 
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (Array.isArray(restoredData) && restoredData.every(item => item.id && item.type && item.amount)) {
                            if (confirm('현재 데이터를 복구 데이터로 덮어쓰시겠습니까?')) {
                                STATE.transactions = restoredData;
                                saveData();
                                updateAllViews();
                                alert('데이터 복구가 완료되었습니다.');
                            }
                        } else {
                            alert('잘못된 형식의 파일입니다.');
                        }
                    } catch (error) {
                        alert('파일을 읽는 도중 오류가 발생했습니다.');
                        console.error('Restore Error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // 파일 입력 초기화
            }


            // --- 이벤트 리스너 바인딩 ---
            elements.navBtns.forEach(btn => {
                const pageId = btn.dataset.page;
                if (pageId) {
                    btn.addEventListener('click', () => changePage(pageId));
                }
            });

            elements.addEntryBtn.addEventListener('click', () => openEntryModal());
            elements.cancelEntryBtn.addEventListener('click', closeEntryModal);
            elements.entryModal.addEventListener('click', (e) => {
                if (e.target.id === 'entry-modal') closeEntryModal(); // 배경 클릭 시 닫기
            });
            elements.saveEntryBtn.addEventListener('click', handleSaveEntry);
            elements.deleteEntryBtn.addEventListener('click', handleDeleteEntry);
            
            elements.btnExpense.addEventListener('click', () => updateFormType('expense'));
            elements.btnIncome.addEventListener('click', () => updateFormType('income'));
            elements.entryCategory.addEventListener('change', () => {
                const category = elements.entryCategory.value;
                const isExpense = CATEGORIES.expense.includes(category);
                const isIncome = CATEGORIES.income.includes(category);
                if (isExpense && currentFormType !== 'expense') updateFormType('expense');
                if (isIncome && currentFormType !== 'income') updateFormType('income');
            });


            // 설정 페이지 리스너
            elements.darkModeToggle.addEventListener('change', (e) => {
                applyTheme(e.target.checked ? 'dark' : 'light');
            });
            elements.saveApiKeysBtn.addEventListener('click', saveApiKeys);
            elements.backupDataBtn.addEventListener('click', backupData);
            elements.restoreDataBtn.addEventListener('click', restoreData);
            elements.restoreDataInput.addEventListener('change', handleRestoreFile);

            // AI/OCR 리스너
            elements.btnOcr.addEventListener('click', () => {
                const ocrKey = localStorage.getItem('ocrApiKey');
                if (!ocrKey) {
                    alert('설정 > OCR API 키를 먼저 입력해주세요.');
                    changePage('settings-page');
                } else {
                    elements.ocrReceiptInput.click();
                }
            });
            elements.ocrReceiptInput.addEventListener('change', handleOcrUpload);
            elements.aiAdviceCloseBtn.addEventListener('click', () => {
                elements.aiAdviceModal.style.display = 'none';
            });
            
            elements.prevMonthBtn.addEventListener('click', () => {
                STATE.currentDate.setMonth(STATE.currentDate.getMonth() - 1);
                updateAllViews();
            });

            elements.nextMonthBtn.addEventListener('click', () => {
                STATE.currentDate.setMonth(STATE.currentDate.getMonth() + 1);
                updateAllViews();
            });


            // --- 초기화 ---
            function updateAllViews() {
                renderCalendar();
                if (elements.statsPage.classList.contains('active')) {
                     renderStats(); 
                }
            }

            function initialize() {
                applyTheme(STATE.currentTheme);
                loadApiKeys();
                updateCategoryOptions(currentFormType); 
                updateAllViews();
                
                Chart.defaults.font.family = 'Nanum Gothic, sans-serif';
                Chart.defaults.color = 'var(--text-color)';
            }

            // DOMContentLoaded가 발생하면 모든 초기화를 시작합니다.
            initialize();
        });
    </script>
</body>
</html>
