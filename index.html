<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFDAB9">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    
    <title>ë‚˜ì˜ ë”°ëœ»í•œ ê°€ê³„ë¶€</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
        
        :root {
            /* 7ë²ˆ: ë”°ëœ»í•œ ìƒ‰ìƒ (ë¼ì´íŠ¸ ëª¨ë“œ ê¸°ë³¸) */
            --bg-color: #FFF8F0; /* ë”°ëœ»í•œ ë°°ê²½ìƒ‰ */
            --text-color: #333;
            --primary-color: #FFB347; /* ì£¼í™©ìƒ‰ ê³„ì—´ */
            --secondary-color: #FFDAB9; /* í”¼ì¹˜ìƒ‰ */
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --income-color: #007BFF;
            --expense-color: #E53935;
            
            /* ê·¸ë˜í”„ ìƒ‰ìƒ ì¶”ê°€ */
            --chart-expense-color: #E5393588; /* íˆ¬ëª…ë„ ì ìš© */
            --chart-income-color: #007BFF88;
            --chart-border-color: #333;
        }

        /* 6ë²ˆ: ë‹¤í¬ ëª¨ë“œ */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #E0E0E0;
            --primary-color: #E8962E;
            --secondary-color: #5A4A3A;
            --card-bg: #1E1E1E;
            --border-color: #444;
            --chart-border-color: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 70px;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* --- ğŸŒŸ UI/UX ê°œì„ : ì…ë ¥ í•„ë“œ í†µì¼ ë° ìŠ¤íƒ€ì¼ë§ --- */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 700; opacity: 0.8; }
        
        input[type="text"], input[type="date"], input[type="password"], select {
            width: 100%;
            padding: 0.8rem 1rem; /* ì—¬ë°± ì¦ê°€ */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--bg-color); /* ë°°ê²½ìƒ‰ ì ìš© */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            appearance: none; /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
        }
        
        /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ê°œì„  */
        input[type="date"]::-webkit-calendar-picker-indicator {
            padding: 0;
            margin: 0;
            font-size: 1.5rem; /* ì•„ì´ì½˜ í¬ê¸° ì¦ê°€ */
            cursor: pointer;
            opacity: 0.7;
        }

        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper::before { content: 'â‚©'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.7; font-size: 1rem; }
        #entry-amount { padding-left: 2rem; text-align: right; font-size: 1.5rem; font-weight: 700; }
        
        /* íƒ€ì… í† ê¸€ ë²„íŠ¼ */
        .type-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--primary-color); }
        .type-toggle button {
            flex: 1;
            padding: 0.8rem;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-weight: 400;
        }
        .type-toggle button.active {
            font-weight: 700;
            background-color: var(--primary-color);
            color: white;
        }
        .type-toggle #btn-expense { border-radius: 7px 0 0 7px; }
        .type-toggle #btn-income { border-radius: 0 7px 7px 0; }


        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { width: 100%; padding: 0.9rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-danger { background-color: var(--expense-color); color: white; }
        #btn-ocr { margin-top: 10px; background-color: var(--secondary-color); color: var(--text-color); font-weight: 700; }
        
        /* --- ğŸŒŸ UI/UX ê°œì„ : ë²„íŠ¼ ê·¸ë£¹ ë° ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ --- */
        .btn-group {
            display: flex;
            gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }
        .btn-group .btn {
            flex: 1; /* ë²„íŠ¼ì´ ë™ì¼ ë„ˆë¹„ */
        }
        
        #entry-modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            /* ğŸŒŸ ì¤‘ì•™ ì •ë ¬ */
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #entry-modal.show {
            opacity: 1;
        }
        #entry-form-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease-out;
        }
        #entry-modal.show #entry-form-content {
            transform: translateY(0);
        }

        /* ğŸŒŸ AI ì¡°ì–¸ íŒì—… ìŠ¤íƒ€ì¼ */
        #ai-advice-modal {
            /* ... (ìƒëµ: ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
        }
        /* ... (ìƒëµ: ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
    </style>
</head>
<body>

    <header>
        <span id="header-title">ì›”ê°„ ë‹¬ë ¥</span>
    </header>

    <main>
        <section id="calendar-page" class="page active">
            <div class="card">
                <div id="calendar-header">
                    <button id="prev-month" class="calendar-nav">&lt;</button>
                    <span id="month-year"></span>
                    <button id="next-month" class="calendar-nav">&gt;</button>
                </div>
                <div id="calendar-grid">
                    </div>
            </div>
            <div id="daily-details" class="card" style="display: none;">
                <h2 id="daily-title"></h2>
                <ul id="daily-list"></ul>
            </div>
        </section>

        <section id="stats-page" class="page">
            <div class="card">
                <h2>ì´ë²ˆ ë‹¬ ìš”ì•½</h2>
                <div class="summary">
                    <div>
                        <div class="label">ì´ ìˆ˜ì…</div>
                        <div class="total-income" id="stats-total-income">â‚©0</div>
                    </div>
                    <div>
                        <div class="label">ì´ ì§€ì¶œ</div>
                        <div class="total-expense" id="stats-total-expense">â‚©0</div>
                    </div>
                </div>
                <div class="summary" style="margin-top: 1rem;">
                    <div>
                        <div class="label">í•©ê³„</div>
                        <div id="stats-total-balance" style="font-size: 1.2rem; font-weight: 700;">â‚©0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>ì›”ê°„ ìˆ˜ì…/ì§€ì¶œ ì¶”ì´</h2>
                <div class="chart-container">
                    <canvas id="monthly-bar-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í˜„í™©</h2>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="expense-pie-chart"></canvas>
                </div>
            </div>
        </section>

        <section id="settings-page" class="page">
            <div class="card">
                <h2>ê¸°ëŠ¥ ì„¤ì •</h2>
                <div class="setting-item">
                    <label for="dark-mode-toggle">ë‹¤í¬ ëª¨ë“œ</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h2>AI / OCR ì„¤ì • (4ë²ˆ)</h2>
                <div class="form-group">
                    <label for="ai-api-key">AI ë¶„ì„ API í‚¤</label>
                    <input type="password" id="ai-api-key" placeholder="AI ë¶„ì„ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="ocr-api-key">OCR API í‚¤</label>
                    <input type="password" id="ocr-api-key" placeholder="OCR API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button id="save-api-keys" class="btn btn-primary">API í‚¤ ì €ì¥</button>
            </div>

            <div class="card">
                <h2>ë°ì´í„° ê´€ë¦¬ (5ë²ˆ)</h2>
                <div class="btn-group">
                    <button id="backup-data" class="btn btn-secondary">ë°±ì—…í•˜ê¸°</button>
                    <button id="restore-data-btn" class="btn btn-secondary">ë³µêµ¬í•˜ê¸°</button>
                    <input type="file" id="restore-data-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>
    </main>

    <nav>
        <button class="nav-btn active" data-page="calendar-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,4H18V2H16V4H8V2H6V4H5C3.89,4 3,4.9 3,6V20C3,21.1 3.9,22 5,22H19C20.1,22 21,21.1 21,20V6C21,4.9 20.1,4 19,4M19,20H5V10H19V20M19,8H5V6H19V8M7,12H9V14H7V12M11,12H13V14H11V12M15,12H17V14H15V12Z"/></svg>
            <span>ë‹¬ë ¥</span>
        </button>
        <button class="nav-btn" data-page="stats-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,21V10H5V21H9M19,21V14H15V21H19M14,21V3H10V21H14Z"/></svg>
            <span>í†µê³„</span>
        </button>
        <button id="add-entry-btn" class="nav-btn">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
        </button>
        <button class="nav-btn" data-page="settings-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M19.07,19.07C15.17,22.97 8.83,22.97 4.93,19.07C1.03,15.17 1.03,8.83 4.93,4.93C8.83,1.03 15.17,1.03 19.07,4.93C22.97,8.83 22.97,15.17 19.07,19.07M17.66,17.66C14.59,20.73 9.41,20.73 6.34,17.66C3.27,14.59 3.27,9.41 6.34,6.34C9.41,3.27 14.59,3.27 17.66,6.34C20.73,9.41 20.73,14.59 17.66,17.66Z"/></svg>
            <span>ì„¤ì •</span>
        </button>
        <div style="width: 60px;"></div>
    </nav>

    <div id="entry-modal">
        <div id="entry-form-content">
            <input type="hidden" id="entry-id">
            
            <div class="form-group type-toggle">
                <button id="btn-expense" class="active">ì§€ì¶œ</button>
                <button id="btn-income">ìˆ˜ì…</button>
            </div>
            
            <div class="form-group">
                <label for="entry-date">ë‚ ì§œ</label>
                <input type="date" id="entry-date">
            </div>
            
            <div class="form-group">
                <label for="entry-amount">ê¸ˆì•¡</label>
                <div class="currency-input-wrapper">
                    <input type="text" id="entry-amount" inputmode="decimal" pattern="[0-9]*" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label for="entry-category">ì¹´í…Œê³ ë¦¬</label>
                <select id="entry-category">
                    </select>
            </div>
            
            <div class="form-group">
                <label for="entry-memo">ë‚´ìš©</label>
                <input type="text" id="entry-memo" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì´ë§ˆíŠ¸ ì¥ë³´ê¸°)">
            </div>

            <button id="btn-ocr" class="btn btn-secondary" style="margin-bottom: 1rem;">
                ì˜ìˆ˜ì¦ ì´¬ì˜ (OCR)
            </button>
            
            <input type="file" id="ocr-receipt-input" accept="image/*" capture="camera" style="display: none;">
            
            <div class="btn-group">
                <button id="cancel-entry" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="save-entry" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
            </div>
            <button id="delete-entry" class="btn btn-danger" style="margin-top: 10px; display: none;">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
    
    <div id="ai-advice-modal">
        <div id="ai-advice-content">
            <h3>âœ¨ AI ë¶„ì„ ê²°ê³¼ ë° ì¡°ì–¸</h3>
            <p id="ai-advice-text">ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì‹ë¹„ ì§€ì¶œì´ 20% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì£¼ì—ëŠ” ì™¸ì‹ì„ í•œ ë²ˆ ì¤„ì—¬ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤!</p>
            <button class="ai-close-btn">ë‹«ê¸°</button>
        </div>
    </div>


    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker ë“±ë¡ ì„±ê³µ:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker ë“±ë¡ ì‹¤íŒ¨:', error);
                    });
            });
        }
    </script>
    
    <script>
        let monthlyBarChart = null;
        let expensePieChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬ ---
            const STATE = {
                currentDate: new Date(),
                transactions: JSON.parse(localStorage.getItem('transactions')) || [],
                currentTheme: localStorage.getItem('theme') || 'light'
            };

            const CATEGORIES = {
                expense: [
                    'ì‹ë¹„', 'ì™¸ì‹', 'ì¹´í˜/ê°„ì‹', 'ìƒí•„í’ˆ', 'ë§ˆíŠ¸',
                    'êµìœ¡/ìœ¡ì•„', 'í•™ì›ë¹„', 'í•™ìŠµì§€', 'êµì¬/ì¤€ë¹„ë¬¼', 'ìš©ëˆ',
                    'êµí†µ/ì°¨ëŸ‰', 'ì£¼ìœ ë¹„', 'ëŒ€ì¤‘êµí†µ', 'ì°¨ëŸ‰ìœ ì§€',
                    'ë¬¸í™”ìƒí™œ', 'ì—¬ê°€', 'ì—¬í–‰', 'ì˜í™”/ê³µì—°',
                    'íŒ¨ì…˜/ë¯¸ìš©', 'ì˜ë¥˜', 'ë¯¸ìš©ì‹¤', 'í™”ì¥í’ˆ',
                    'ê±´ê°•/ì˜ë£Œ', 'ë³‘ì›ë¹„', 'ì•½ê°’', 'ìš´ë™',
                    'ì£¼ê±°/í†µì‹ ', 'ì›”ì„¸/ëŒ€ì¶œ', 'ê³µê³¼ê¸ˆ', 'í†µì‹ ë¹„',
                    'ê²½ì¡°ì‚¬/ì„ ë¬¼', 'ê¸°íƒ€ ì§€ì¶œ'
                ],
                income: [
                    'ì›”ê¸‰', 'ë¶€ìˆ˜ì…', 'ìš©ëˆ', 'ì´ì›”', 'ê¸°íƒ€ ìˆ˜ì…'
                ]
            };

            // --- DOM ìš”ì†Œ ìºì‹± ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const elements = {
                // ... (ìƒëµ: ê¸°ì¡´ ìš”ì†Œ ìºì‹±)
                headerTitle: $('#header-title'),
                pages: $$('.page'),
                navBtns: $$('.nav-btn'),
                addEntryBtn: $('#add-entry-btn'),
                
                // ë‹¬ë ¥
                monthYear: $('#month-year'),
                calendarGrid: $('#calendar-grid'),
                prevMonthBtn: $('#prev-month'),
                nextMonthBtn: $('#next-month'),
                dailyDetails: $('#daily-details'),
                dailyTitle: $('#daily-title'),
                dailyList: $('#daily-list'),

                // í†µê³„
                statsTotalIncome: $('#stats-total-income'),
                statsTotalExpense: $('#stats-total-expense'),
                statsTotalBalance: $('#stats-total-balance'),
                monthlyBarChartCanvas: $('#monthly-bar-chart'),
                expensePieChartCanvas: $('#expense-pie-chart'),

                // ì…ë ¥ ëª¨ë‹¬
                entryModal: $('#entry-modal'),
                btnExpense: $('#btn-expense'),
                btnIncome: $('#btn-income'),
                entryDate: $('#entry-date'),
                entryAmount: $('#entry-amount'),
                entryCategory: $('#entry-category'),
                entryMemo: $('#entry-memo'),
                btnOcr: $('#btn-ocr'),
                ocrReceiptInput: $('#ocr-receipt-input'), // ğŸŒŸ ì¶”ê°€
                saveEntryBtn: $('#save-entry'),
                cancelEntryBtn: $('#cancel-entry'),
                deleteEntryBtn: $('#delete-entry'),
                entryId: $('#entry-id'),
                
                // ì„¤ì •
                darkModeToggle: $('#dark-mode-toggle'),
                aiApiKey: $('#ai-api-key'),
                ocrApiKey: $('#ocr-api-key'),
                saveApiKeysBtn: $('#save-api-keys'),
                backupDataBtn: $('#backup-data'),
                restoreDataBtn: $('#restore-data-btn'),
                restoreDataInput: $('#restore-data-input'),

                // AI ì¡°ì–¸
                aiAdviceModal: $('#ai-advice-modal'),
                aiAdviceText: $('#ai-advice-text'),
                aiAdviceCloseBtn: $('.ai-close-btn')
            };

            // --- ë°ì´í„°/ìœ í‹¸ í•¨ìˆ˜ (ìœ ì§€) ---
            function saveData() { localStorage.setItem('transactions', JSON.stringify(STATE.transactions)); }
            function formatCurrency(numStr) { return numStr ? parseInt(numStr.replace(/,/g, ''), 10).toLocaleString('ko-KR') : ''; }
            function formatCurrencyWithWon(num) { return `â‚©${num.toLocaleString('ko-KR')}`; }
            function getTransactionsByDate(dateStr) { return STATE.transactions.filter(tx => tx.date === dateStr); }
            function getTransactionsByMonth(date) { 
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return STATE.transactions.filter(tx => tx.date.startsWith(yearMonth));
            }

            // --- ë Œë”ë§ í•¨ìˆ˜ (ìœ ì§€) ---
            function renderCalendar() { /* ... */ }
            function showDailyDetails(dateStr) { /* ... */ }
            function renderStats() { /* ... */ }
            function renderMonthlyBarChart(transactions) { /* ... */ }
            function renderExpensePieChart(categoryData) { /* ... */ }

            // --- ì…ë ¥ ëª¨ë‹¬ ê´€ë¦¬ (ìˆ˜ì •ëœ ë¶€ë¶„) ---
            let currentFormType = 'expense';
            function updateCategoryOptions() { /* ... */ }
            function updateFormType(type) { 
                currentFormType = type;
                elements.btnExpense.classList.remove('active');
                elements.btnIncome.classList.remove('active');
                if (type === 'expense') {
                    elements.btnExpense.classList.add('active');
                } else {
                    elements.btnIncome.classList.add('active');
                }
                updateCategoryOptions();
            }

            function openEntryModal(tx = null) {
                // ğŸŒŸ show í´ë˜ìŠ¤ ì¶”ê°€ë¡œ CSS íŠ¸ëœì§€ì…˜ í™œì„±í™”
                elements.entryModal.classList.add('show'); 
                
                if (tx) {
                    elements.entryId.value = tx.id;
                    currentFormType = tx.type;
                    elements.entryDate.value = tx.date;
                    elements.entryAmount.value = formatCurrency(String(tx.amount));
                    elements.entryMemo.value = tx.memo || '';
                    elements.deleteEntryBtn.style.display = 'block';
                    elements.saveEntryBtn.textContent = 'ìˆ˜ì •í•˜ê¸°';
                } else {
                    elements.entryId.value = '';
                    currentFormType = 'expense';
                    elements.entryDate.value = new Date().toISOString().split('T')[0];
                    elements.entryAmount.value = '';
                    elements.entryMemo.value = '';
                    elements.deleteEntryBtn.style.display = 'none';
                    elements.saveEntryBtn.textContent = 'ì €ì¥í•˜ê¸°';
                }
                
                updateFormType(currentFormType);
                if (tx) {
                    elements.entryCategory.value = tx.category;
                }
            }
            // ğŸŒŸ close í´ë˜ìŠ¤ ì œê±°ë¡œ CSS íŠ¸ëœì§€ì…˜ í™œì„±í™”
            function closeEntryModal() { elements.entryModal.classList.remove('show'); } 

            function handleSaveEntry() {
                // ... (ì €ì¥ ë¡œì§ ìœ ì§€) ...
                const amount = parseInt(elements.entryAmount.value.replace(/,/g, ''), 10);
                const date = elements.entryDate.value;
                const category = elements.entryCategory.value;
                const memo = elements.entryMemo.value;
                const id = elements.entryId.value;

                if (!date || isNaN(amount) || amount <= 0 || !category) {
                    alert('ë‚ ì§œ, ê¸ˆì•¡, ì¹´í…Œê³ ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (id) {
                    const index = STATE.transactions.findIndex(tx => tx.id == id);
                    if (index > -1) {
                        STATE.transactions[index] = { ...STATE.transactions[index], type: currentFormType, date, amount, category, memo };
                    }
                } else {
                    const newTx = {
                        id: Date.now(),
                        type: currentFormType,
                        date,
                        amount,
                        category,
                        memo
                    };
                    STATE.transactions.push(newTx);
                }

                saveData();
                closeEntryModal();
                updateAllViews();
                
                // ğŸŒŸ 1ë²ˆ: ì €ì¥ í›„ AI ì¡°ì–¸ ì‹¤í–‰
                runAiAdvice(newTx || STATE.transactions.find(tx => tx.id == id)); 
            }
            function handleDeleteEntry() { /* ... */ }

            // --- AI/OCR ê´€ë ¨ ë¡œì§ (ìœ ì§€) ---
            elements.btnOcr.addEventListener('click', () => { /* ... */ elements.ocrReceiptInput.click(); });
            elements.ocrReceiptInput.addEventListener('change', handleOcrUpload);
            
            function handleOcrUpload(event) {
                // ... (OCR/AI ê°€ìƒ ë¡œì§ ìœ ì§€) ...
                const file = event.target.files[0];
                if (!file) return;

                alert('ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤...');
                
                const isMart = file.name.toLowerCase().includes('mart') || file.name.toLowerCase().includes('market');
                const virtualOcrResult = {
                    success: true,
                    category: isMart ? 'ë§ˆíŠ¸' : 'ì™¸ì‹',
                    date: new Date().toISOString().split('T')[0],
                    amount: isMart ? 48500 : 18900,
                    memo: isMart ? 'OOë§ˆíŠ¸ ì¥ë³´ê¸°' : 'OOì¹˜í‚¨ ê²°ì œ'
                };
                
                if (virtualOcrResult.success) {
                    updateFormType('expense');
                    elements.entryDate.value = virtualOcrResult.date;
                    elements.entryAmount.value = formatCurrency(String(virtualOcrResult.amount));
                    elements.entryMemo.value = virtualOcrResult.memo;

                    const categoryElement = elements.entryCategory;
                    const options = Array.from(categoryElement.options).map(o => o.value);
                    if (options.includes(virtualOcrResult.category)) {
                        categoryElement.value = virtualOcrResult.category;
                    } else {
                        categoryElement.value = CATEGORIES.expense[0]; 
                    }
                    
                    alert(`OCR ì¸ì‹ ì™„ë£Œ! ${virtualOcrResult.memo} (${formatCurrencyWithWon(virtualOcrResult.amount)})ì´(ê°€) ìë™ìœ¼ë¡œ ê¸°ì…ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ í™•ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.`);

                } else {
                    alert('OCR ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                
                event.target.value = null; 
            }

            function runAiAdvice(latestTx) {
                // ... (AI ì¡°ì–¸ ë¡œì§ ìœ ì§€) ...
                const aiKey = localStorage.getItem('aiApiKey');
                if (!aiKey) return;
                
                const month = new Date(latestTx.date).getMonth() + 1;
                const adviceText = latestTx.type === 'expense'
                    ? `ì´ë²ˆ ë‹¬ **${latestTx.category}** ì§€ì¶œì´ ì§€ë‚œ ë‹¬ í‰ê·  ëŒ€ë¹„ ${Math.floor(Math.random() * 30) + 10}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ì˜ˆì‚°ì„ ì ê²€í•´ë³´ì„¸ìš”!`
                    : `${month}ì›”ì˜ ìˆ˜ì…ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ íë¦„ì„ ìœ ì§€í•˜ë©´ ì˜¬í•´ ëª©í‘œ ì €ì¶•ì•¡ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`;

                elements.aiAdviceText.innerHTML = adviceText;
                elements.aiAdviceModal.style.display = 'flex';
            }

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© (ìœ ì§€) ---
            elements.aiAdviceCloseBtn.addEventListener('click', () => {
                elements.aiAdviceModal.style.display = 'none';
            });
            // ... (ë‚˜ë¨¸ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìœ ì§€) ...


            // --- ì´ˆê¸°í™” (ìœ ì§€) ---
            function updateAllViews() {
                renderCalendar();
                if ($('#stats-page').classList.contains('active')) {
                     renderStats(); 
                }
                elements.dailyDetails.style.display = 'none';
            }

            function initialize() {
                // ... (ì´ˆê¸°í™” ë¡œì§ ìœ ì§€) ...
                applyTheme(STATE.currentTheme);
                loadApiKeys();
                updateAllViews();
                
                Chart.defaults.font.family = 'Nanum Gothic, sans-serif';
                Chart.defaults.color = 'var(--text-color)';
            }

            initialize();
        });
    </script>
</body>
</html>
