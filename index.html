<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFDAB9">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    
    <title>ë‚˜ì˜ ë”°ëœ»í•œ ê°€ê³„ë¶€</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
        
        :root {
            /* 7ë²ˆ: ë”°ëœ»í•œ ìƒ‰ìƒ (ë¼ì´íŠ¸ ëª¨ë“œ ê¸°ë³¸) */
            --bg-color: #FFF8F0; /* ë”°ëœ»í•œ ë°°ê²½ìƒ‰ */
            --text-color: #333;
            --primary-color: #FFB347; /* ì£¼í™©ìƒ‰ ê³„ì—´ */
            --secondary-color: #FFDAB9; /* í”¼ì¹˜ìƒ‰ */
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --income-color: #007BFF;
            --expense-color: #E53935;
            
            /* ê·¸ë˜í”„ ìƒ‰ìƒ ì¶”ê°€ */
            --chart-expense-color: #E5393588; /* íˆ¬ëª…ë„ ì ìš© */
            --chart-income-color: #007BFF88;
            --chart-border-color: #333;
        }

        /* 6ë²ˆ: ë‹¤í¬ ëª¨ë“œ */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #E0E0E0;
            --primary-color: #E8962E;
            --secondary-color: #5A4A3A;
            --card-bg: #1E1E1E;
            --border-color: #444;
            --chart-border-color: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 20;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 70px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ê³µê°„ í™•ë³´ */
            z-index: 1;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ (ìƒëµ) */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-nav { background: none; border: none; font-size: 1.5rem; color: var(--text-color); padding: 0.5rem; cursor: pointer; }
        .day-cell { padding: 0.5rem 0; border-radius: 8px; cursor: pointer; transition: background-color 0.1s; }
        .day-cell.today { border: 2px solid var(--primary-color); }
        .day-cell.has-entry { background-color: var(--secondary-color); font-weight: 700; }
        .day-cell.selected { background-color: var(--primary-color); color: white; }

        /* í†µê³„ ìŠ¤íƒ€ì¼ (ìƒëµ) */
        .summary { display: flex; justify-content: space-around; margin-bottom: 1rem; }
        .summary .total-income { color: var(--income-color); }
        .summary .total-expense { color: var(--expense-color); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 1rem; }
        .chart-container[style*="250px"] { height: 250px; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 700; font-size: 0.9rem; color: var(--primary-color); }
        
        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper::before { 
            content: 'â‚©'; 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-color); 
            opacity: 0.7; 
            font-size: 1.5rem; /* ì›í™” í‘œì‹œ í¬ê¸° í™•ëŒ€ */
            font-weight: 700;
        }
        #entry-amount { 
            padding-left: 2.5rem; /* ì›í™” í‘œì‹œ ê³µê°„ í™•ë³´ */
            text-align: right; 
            font-size: 1.5rem; 
            font-weight: 700; 
            padding-right: 0.75rem;
        }
        
        /* ì…ë ¥ í•„ë“œ/ì„ íƒ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        input[type="date"], input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            margin-top: 0.25rem;
        }
        
        /* íƒ€ì… í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .type-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--primary-color); }
        .type-toggle button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .type-toggle button:first-child {
            border-top-left-radius: 7px;
            border-bottom-left-radius: 7px;
        }
        .type-toggle button:last-child {
            border-top-right-radius: 7px;
            border-bottom-right-radius: 7px;
        }
        #btn-expense.active {
            background-color: var(--expense-color);
            color: white;
            border-right: 1px solid var(--primary-color);
        }
        #btn-income.active {
            background-color: var(--income-color);
            color: white;
            border-left: 1px solid var(--primary-color);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { width: 100%; padding: 0.9rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-color); }
        .btn-danger { background-color: var(--expense-color); color: white; }
        #btn-ocr { background-color: var(--secondary-color); color: var(--text-color); font-weight: 700; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-group .btn {
            flex: 1;
        }

        /* ğŸŒŸ ì…ë ¥ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #entry-modal {
            display: none; /* JSë¡œ 'show' í´ë˜ìŠ¤ í† ê¸€ */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* ì–´ë‘ìš´ ë°°ê²½ */
            align-items: flex-end; /* ì•„ë˜ìª½ì—ì„œ ì˜¬ë¼ì˜¤ë„ë¡ */
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        #entry-modal.show {
            display: flex; /* ë³´ì´ê¸° */
        }

        #entry-form-content {
            background-color: var(--bg-color);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px; /* ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ */
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        #entry-modal.show #entry-form-content {
            transform: translateY(0);
        }

        /* ğŸŒŸ AI ì¡°ì–¸ íŒì—… ìŠ¤íƒ€ì¼ */
        #ai-advice-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        #ai-advice-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        #ai-advice-content h3 {
            color: var(--income-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ai-advice-content p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 1rem;
        }
        .ai-close-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }
        
        /* ğŸŒŸ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor; /* SVG ìƒ‰ìƒì„ í˜„ì¬ í…ìŠ¤íŠ¸ ìƒ‰ìƒìœ¼ë¡œ ì„¤ì • */
            margin-bottom: 2px;
        }
        
        #add-entry-btn {
            /* + ë²„íŠ¼ ì¤‘ì•™ ë°°ì¹˜ ë° ì‹œê°ì  ê°•ì¡° */
            background-color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-top: -30px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìœ„ë¡œ ë„ìš°ê¸° */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 2rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--bg-color); /* ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•œ í…Œë‘ë¦¬ */
            z-index: 11;
        }
        
        #add-entry-btn svg {
            fill: white;
        }
        
        /* ğŸŒŸ ì„¤ì • í•­ëª© ìŠ¤íƒ€ì¼ */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        
        /* ğŸŒŸ ìŠ¤ìœ„ì¹˜ í† ê¸€ (ë‹¤í¬ ëª¨ë“œ) ìŠ¤íƒ€ì¼ */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 25px;
        }
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 25px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 19px;
          width: 19px;
          left: 3px;
          bottom: 3px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--primary-color);
        }
        input:checked + .slider:before {
          transform: translateX(25px);
        }
    </style>
</head>
<body>

    <header>
        <span id="header-title">ì›”ê°„ ë‹¬ë ¥</span>
    </header>

    <main>
        <section id="calendar-page" class="page active">
            <div class="card">
                <div id="calendar-header">
                    <button id="prev-month" class="calendar-nav">&lt;</button>
                    <span id="month-year"></span>
                    <button id="next-month" class="calendar-nav">&gt;</button>
                </div>
                <div id="calendar-grid">
                    </div>
            </div>
            <div id="daily-details" class="card" style="display: none;">
                <h2 id="daily-title"></h2>
                <ul id="daily-list"></ul>
            </div>
        </section>

        <section id="stats-page" class="page">
            <div class="card">
                <h2>ì´ë²ˆ ë‹¬ ìš”ì•½</h2>
                <div class="summary">
                    <div>
                        <div class="label">ì´ ìˆ˜ì…</div>
                        <div class="total-income" id="stats-total-income">â‚©0</div>
                    </div>
                    <div>
                        <div class="label">ì´ ì§€ì¶œ</div>
                        <div class="total-expense" id="stats-total-expense">â‚©0</div>
                    </div>
                </div>
                <div class="summary" style="margin-top: 1rem;">
                    <div>
                        <div class="label">í•©ê³„</div>
                        <div id="stats-total-balance" style="font-size: 1.2rem; font-weight: 700;">â‚©0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>ì›”ê°„ ìˆ˜ì…/ì§€ì¶œ ì¶”ì´</h2>
                <div class="chart-container">
                    <canvas id="monthly-bar-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í˜„í™©</h2>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="expense-pie-chart"></canvas>
                </div>
            </div>
            
        </section>

        <section id="settings-page" class="page">
            <div class="card">
                <h2>ê¸°ëŠ¥ ì„¤ì •</h2>
                <div class="setting-item">
                    <label for="dark-mode-toggle">ë‹¤í¬ ëª¨ë“œ</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h2>AI / OCR ì„¤ì • (4ë²ˆ)</h2>
                <div class="form-group">
                    <label for="ai-api-key">AI ë¶„ì„ API í‚¤</label>
                    <input type="password" id="ai-api-key" placeholder="AI ë¶„ì„ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="ocr-api-key">OCR API í‚¤</label>
                    <input type="password" id="ocr-api-key" placeholder="OCR API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button id="save-api-keys" class="btn btn-primary">API í‚¤ ì €ì¥</button>
            </div>

            <div class="card">
                <h2>ë°ì´í„° ê´€ë¦¬ (5ë²ˆ)</h2>
                <div class="btn-group">
                    <button id="backup-data" class="btn btn-secondary">ë°±ì—…í•˜ê¸°</button>
                    <button id="restore-data-btn" class="btn btn-secondary">ë³µêµ¬í•˜ê¸°</button>
                    <input type="file" id="restore-data-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>
    </main>

    <nav>
        <button class="nav-btn active" data-page="calendar-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,4H18V2H16V4H8V2H6V4H5C3.89,4 3,4.9 3,6V20C3,21.1 3.9,22 5,22H19C20.1,22 21,21.1 21,20V6C21,4.9 20.1,4 19,4M19,20H5V10H19V20M19,8H5V6H19V8M7,12H9V14H7V12M11,12H13V14H11V12M15,12H17V14H15V12Z"/></svg>
            <span>ë‹¬ë ¥</span>
        </button>
        <button class="nav-btn" data-page="stats-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,21V10H5V21H9M19,21V14H15V21H19M14,21V3H10V21H14Z"/></svg>
            <span>í†µê³„</span>
        </button>
        <button id="add-entry-btn" class="nav-btn">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
        </button>
        <button class="nav-btn" data-page="settings-page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M19.07,19.07C15.17,22.97 8.83,22.97 4.93,19.07C1.03,15.17 1.03,8.83 4.93,4.93C8.83,1.03 15.17,1.03 19.07,4.93C22.97,8.83 22.97,15.17 19.07,19.07M17.66,17.66C14.59,20.73 9.41,20.73 6.34,17.66C3.27,14.59 3.27,9.41 6.34,6.34C9.41,3.27 14.59,3.27 17.66,6.34C20.73,9.41 20.73,14.59 17.66,17.66Z"/></svg>
            <span>ì„¤ì •</span>
        </button>
        <div style="width: 60px;"></div>
    </nav>

    <div id="entry-modal">
        <div id="entry-form-content">
            <input type="hidden" id="entry-id">
            
            <div class="form-group type-toggle">
                <button id="btn-expense" class="active">ì§€ì¶œ</button>
                <button id="btn-income">ìˆ˜ì…</button>
            </div>
            
            <div class="form-group">
                <label for="entry-date">ë‚ ì§œ</label>
                <input type="date" id="entry-date">
            </div>
            
            <div class="form-group">
                <label for="entry-amount">ê¸ˆì•¡</label>
                <div class="currency-input-wrapper">
                    <input type="text" id="entry-amount" inputmode="decimal" pattern="[0-9]*" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label for="entry-category">ì¹´í…Œê³ ë¦¬</label>
                <select id="entry-category">
                    </select>
            </div>
            
            <div class="form-group">
                <label for="entry-memo">ë‚´ìš©</label>
                <input type="text" id="entry-memo" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì´ë§ˆíŠ¸ ì¥ë³´ê¸°)">
            </div>

            <button id="btn-ocr" class="btn btn-secondary" style="margin-bottom: 10px;">
                ì˜ìˆ˜ì¦ ì´¬ì˜ (OCR)
            </button>
            
            <input type="file" id="ocr-receipt-input" accept="image/*" capture="camera" style="display: none;">
            
            <div class="btn-group">
                <button id="cancel-entry" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="save-entry" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
            </div>
            <button id="delete-entry" class="btn btn-danger" style="margin-top: 10px; display: none;">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
    
    <div id="ai-advice-modal">
        <div id="ai-advice-content">
            <h3>âœ¨ AI ë¶„ì„ ê²°ê³¼ ë° ì¡°ì–¸</h3>
            <p id="ai-advice-text">ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì‹ë¹„ ì§€ì¶œì´ 20% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì£¼ì—ëŠ” ì™¸ì‹ì„ í•œ ë²ˆ ì¤„ì—¬ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤!</p>
            <button class="ai-close-btn">ë‹«ê¸°</button>
        </div>
    </div>


    <script>
        // PWA Service Worker ë“±ë¡ ìŠ¤í¬ë¦½íŠ¸ (ìœ ì§€)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker ë“±ë¡ ì„±ê³µ:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker ë“±ë¡ ì‹¤íŒ¨:', error);
                    });
            });
        }
    </script>
    
    <script>
        // ğŸŒŸ $ì™€ $$ í•¨ìˆ˜ë¥¼ DOMContentLoaded ë°–ìœ¼ë¡œ ë¹¼ë‚´ì–´ ì „ì—­/ìƒìœ„ ìŠ¤ì½”í”„ì— ì •ì˜
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        let monthlyBarChart = null;
        let expensePieChart = null;
        let currentFormType = 'expense'; // ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬

        // ğŸŒŸ DOM ìš”ì†Œ ìºì‹±
        const elements = {
            // í˜ì´ì§€/ë„¤ë¹„ê²Œì´ì…˜
            headerTitle: $('#header-title'),
            pages: $$('.page'),
            navBtns: $$('.nav-btn'),
            addEntryBtn: $('#add-entry-btn'),
            
            // ë‹¬ë ¥
            calendarPage: $('#calendar-page'),
            monthYear: $('#month-year'),
            calendarGrid: $('#calendar-grid'),
            prevMonthBtn: $('#prev-month'),
            nextMonthBtn: $('#next-month'),
            dailyDetails: $('#daily-details'),
            dailyTitle: $('#daily-title'),
            dailyList: $('#daily-list'),

            // í†µê³„
            statsPage: $('#stats-page'), 
            statsTotalIncome: $('#stats-total-income'),
            statsTotalExpense: $('#stats-total-expense'),
            statsTotalBalance: $('#stats-total-balance'),
            monthlyBarChartCanvas: $('#monthly-bar-chart'),
            expensePieChartCanvas: $('#expense-pie-chart'),

            // ì…ë ¥ ëª¨ë‹¬
            entryModal: $('#entry-modal'),
            btnExpense: $('#btn-expense'),
            btnIncome: $('#btn-income'),
            entryDate: $('#entry-date'),
            entryAmount: $('#entry-amount'),
            entryCategory: $('#entry-category'),
            entryMemo: $('#entry-memo'),
            btnOcr: $('#btn-ocr'),
            ocrReceiptInput: $('#ocr-receipt-input'),
            saveEntryBtn: $('#save-entry'),
            cancelEntryBtn: $('#cancel-entry'),
            deleteEntryBtn: $('#delete-entry'),
            entryId: $('#entry-id'),
            
            // ì„¤ì •
            settingsPage: $('#settings-page'),
            darkModeToggle: $('#dark-mode-toggle'),
            aiApiKey: $('#ai-api-key'),
            ocrApiKey: $('#ocr-api-key'),
            saveApiKeysBtn: $('#save-api-keys'),
            backupDataBtn: $('#backup-data'),
            restoreDataBtn: $('#restore-data-btn'),
            restoreDataInput: $('#restore-data-input'),

            // AI ì¡°ì–¸
            aiAdviceModal: $('#ai-advice-modal'),
            aiAdviceText: $('#ai-advice-text'),
            aiAdviceCloseBtn: $('.ai-close-btn')
        };


        // --- DOMContentLoaded ë‚´ë¶€ ë¡œì§ ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬ ---
            const STATE = {
                currentDate: new Date(),
                transactions: JSON.parse(localStorage.getItem('transactions')) || [],
                currentTheme: localStorage.getItem('theme') || 'light'
            };

            const CATEGORIES = {
                expense: [
                    'ì‹ë¹„', 'ì™¸ì‹', 'ì¹´í˜/ê°„ì‹', 'ìƒí•„í’ˆ', 'ë§ˆíŠ¸',
                    'êµìœ¡/ìœ¡ì•„', 'í•™ì›ë¹„', 'í•™ìŠµì§€', 'êµì¬/ì¤€ë¹„ë¬¼', 'ìš©ëˆ',
                    'êµí†µ/ì°¨ëŸ‰', 'ì£¼ìœ ë¹„', 'ëŒ€ì¤‘êµí†µ', 'ì°¨ëŸ‰ìœ ì§€',
                    'ë¬¸í™”ìƒí™œ', 'ì—¬ê°€', 'ì—¬í–‰', 'ì˜í™”/ê³µì—°',
                    'íŒ¨ì…˜/ë¯¸ìš©', 'ì˜ë¥˜', 'ë¯¸ìš©ì‹¤', 'í™”ì¥í’ˆ',
                    'ê±´ê°•/ì˜ë£Œ', 'ë³‘ì›ë¹„', 'ì•½ê°’', 'ìš´ë™',
                    'ì£¼ê±°/í†µì‹ ', 'ì›”ì„¸/ëŒ€ì¶œ', 'ê³µê³¼ê¸ˆ', 'í†µì‹ ë¹„',
                    'ê²½ì¡°ì‚¬/ì„ ë¬¼', 'ê¸°íƒ€ ì§€ì¶œ'
                ],
                income: [
                    'ì›”ê¸‰', 'ë¶€ìˆ˜ì…', 'ìš©ëˆ', 'ì´ì›”', 'ê¸°íƒ€ ìˆ˜ì…'
                ]
            };


            // --- ë°ì´í„°/ìœ í‹¸ í•¨ìˆ˜ ---
            function saveData() { localStorage.setItem('transactions', JSON.stringify(STATE.transactions)); }
            function formatCurrency(numStr) { return numStr ? parseInt(String(numStr).replace(/,/g, ''), 10).toLocaleString('ko-KR') : ''; }
            function formatCurrencyWithWon(num) { return `â‚©${Number(num).toLocaleString('ko-KR')}`; }
            function getTransactionsByDate(dateStr) { return STATE.transactions.filter(tx => tx.date === dateStr); }
            function getTransactionsByMonth(date) { 
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return STATE.transactions.filter(tx => tx.date.startsWith(yearMonth));
            }
            // ì›”/ì—°ë„ í¬ë§·íŒ…
            function getMonthYearString(date) {
                return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›”`;
            }
            // ê¸ˆì•¡ ì…ë ¥ í•„ë“œ í¬ë§·íŒ…
            elements.entryAmount.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
                e.target.value = formatCurrency(value);
            });

            // --- ë·° ê´€ë¦¬ ---
            function changePage(pageId) {
                elements.pages.forEach(page => page.classList.remove('active'));
                $(`#${pageId}`).classList.add('active');
                
                elements.navBtns.forEach(btn => btn.classList.remove('active'));
                const activeNavBtn = $(`[data-page="${pageId}"]`);
                if (activeNavBtn) activeNavBtn.classList.add('active');

                elements.headerTitle.textContent = activeNavBtn ? activeNavBtn.querySelector('span').textContent : 'ê°€ê³„ë¶€';
                
                // í†µê³„ í˜ì´ì§€ì¼ ê²½ìš°ë§Œ ë‹¤ì‹œ ë Œë”ë§
                if (pageId === 'stats-page') {
                    renderStats();
                }
            }

            // --- ë Œë”ë§ í•¨ìˆ˜ ---
            function renderCalendar() {
                const date = STATE.currentDate;
                elements.monthYear.textContent = getMonthYearString(date);
                elements.calendarGrid.innerHTML = ''; // ì´ˆê¸°í™”
                
                // ìš”ì¼ í—¤ë”
                const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dayNames.forEach(day => {
                    const dayNameCell = document.createElement('div');
                    dayNameCell.textContent = day;
                    dayNameCell.style.fontWeight = '700';
                    dayNameCell.style.color = day === 'ì¼' ? 'var(--expense-color)' : day === 'í† ' ? 'var(--income-color)' : 'var(--text-color)';
                    elements.calendarGrid.appendChild(dayNameCell);
                });
                
                // ë‹¬ë ¥ ë‚ ì§œ ê³„ì‚°
                const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const today = new Date().toISOString().split('T')[0];
                const yearMonthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
                for (let i = 0; i < firstDayOfMonth; i++) {
                    elements.calendarGrid.appendChild(document.createElement('div'));
                }
                
                // ë‚ ì§œ ì…€ ì±„ìš°ê¸°
                for (let i = 1; i <= daysInMonth; i++) {
                    const cell = document.createElement('div');
                    const dateStr = `${yearMonthStr}-${String(i).padStart(2, '0')}`;
                    cell.classList.add('day-cell');
                    cell.textContent = i;
                    
                    if (dateStr === today) cell.classList.add('today');
                    
                    // í•´ë‹¹ ë‚ ì§œì— ê±°ë˜ ë‚´ì—­ì´ ìˆëŠ”ì§€ í™•ì¸
                    if (getTransactionsByDate(dateStr).length > 0) {
                        cell.classList.add('has-entry'); 
                    }
                    
                    cell.dataset.date = dateStr;
                    cell.addEventListener('click', () => showDailyDetails(dateStr));
                    elements.calendarGrid.appendChild(cell);
                }
            }
            
            // ğŸŒŸ showDailyDetails í•¨ìˆ˜ êµì²´ (ìˆ˜ì •ëœ ë¶€ë¶„)
            function showDailyDetails(dateStr) { 
                // 1. ì œëª© ì—…ë°ì´íŠ¸
                elements.dailyTitle.textContent = `${dateStr} ìƒì„¸ ë‚´ì—­`;
                
                // 2. í•´ë‹¹ ë‚ ì§œì˜ ê±°ë˜ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
                const transactions = getTransactionsByDate(dateStr);
                
                // 3. ê±°ë˜ ë‚´ì—­ì„ HTML ëª©ë¡ í•­ëª©ìœ¼ë¡œ ë³€í™˜ (Map)
                const list = transactions.map(tx => {
                    const sign = tx.type === 'income' ? '+' : '-';
                    const color = tx.type === 'income' ? 'var(--income-color)' : 'var(--expense-color)';
                    
                    return `
                        <li style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color);" 
                            onclick="openEntryModal(STATE.transactions.find(t => t.id === ${tx.id}))">
                            <div>
                                <span style="font-weight: 700; color: ${color}; margin-right: 0.5rem;">[${tx.category}]</span>
                                <span>${tx.memo || 'ë‚´ìš© ì—†ìŒ'}</span>
                            </div>
                            <span style="font-weight: 700; color: ${color};">${sign} ${formatCurrency(String(tx.amount))}</span>
                        </li>
                    `;
                }).join(''); // ë°°ì—´ì„ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©

                // 4. ë¦¬ìŠ¤íŠ¸ë¥¼ í™”ë©´ì— ì¶œë ¥
                elements.dailyList.innerHTML = list.length > 0 ? list : '<li>í•­ëª© ì—†ìŒ</li>';
                elements.dailyDetails.style.display = 'block';
                
                // 5. ë‹¬ë ¥ì˜ ì„ íƒëœ ë‚ ì§œ ì…€ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                $$('.day-cell').forEach(cell => cell.classList.remove('selected'));
                const selectedCell = $(`[data-date="${dateStr}"]`);
                if (selectedCell) {
                    selectedCell.classList.add('selected');
                }
            }
            
            function renderStats() {
                const currentMonthTransactions = getTransactionsByMonth(STATE.currentDate);
                let totalIncome = 0;
                let totalExpense = 0;
                const categoryTotals = {};
                
                currentMonthTransactions.forEach(tx => {
                    if (tx.type === 'income') {
                        totalIncome += tx.amount;
                    } else {
                        totalExpense += tx.amount;
                        categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount;
                    }
                });

                elements.statsTotalIncome.textContent = formatCurrencyWithWon(totalIncome);
                elements.statsTotalExpense.textContent = formatCurrencyWithWon(totalExpense);
                elements.statsTotalBalance.textContent = formatCurrencyWithWon(totalIncome - totalExpense);

                renderMonthlyBarChart(currentMonthTransactions);
                renderExpensePieChart(categoryTotals);
            }
            
            function renderMonthlyBarChart(transactions) {
                if (monthlyBarChart) monthlyBarChart.destroy();
                
                // ğŸŒŸ ì‹¤ì œ ë°ì´í„° ë¶„ì„ (ì„ì˜ì˜ ë°ì´í„° ëŒ€ì‹  ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°ë¥¼ ì£¼ê°„ í•©ì‚°í•´ì•¼ í•¨)
                // í˜„ì¬ëŠ” ê°€ìƒ ë°ì´í„° ê·¸ëŒ€ë¡œ ìœ ì§€
                monthlyBarChart = new Chart(elements.monthlyBarChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['1ì£¼', '2ì£¼', '3ì£¼', '4ì£¼'],
                        datasets: [
                            {
                                label: 'ìˆ˜ì…',
                                data: [150000, 0, 200000, 0],
                                backgroundColor: 'var(--chart-income-color)',
                                borderColor: 'var(--income-color)',
                                borderWidth: 1
                            },
                            {
                                label: 'ì§€ì¶œ',
                                data: [50000, 80000, 30000, 40000],
                                backgroundColor: 'var(--chart-expense-color)',
                                borderColor: 'var(--expense-color)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            function renderExpensePieChart(categoryData) {
                if (expensePieChart) expensePieChart.destroy();
                const labels = Object.keys(categoryData);
                const data = Object.values(categoryData);
                
                expensePieChart = new Chart(elements.expensePieChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length > 0 ? labels : ['ì§€ì¶œ ì—†ìŒ'],
                        datasets: [{
                            data: data.length > 0 ? data : [1],
                            backgroundColor: labels.length > 0 ? ['#E53935', '#FF9800', '#03A9F4', '#4CAF50'] : ['#E0E0E0'],
                            hoverOffset: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: labels.length > 0
                            }
                        }
                    }
                });
            }


            // --- ì…ë ¥ ëª¨ë‹¬ ê´€ë¦¬ ---
            
            function updateCategoryOptions(type) {
                const categories = CATEGORIES[type] || [];
                elements.entryCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                elements.entryCategory.value = categories[0] || '';
            }

            function updateFormType(type) {
                currentFormType = type;
                elements.btnExpense.classList.toggle('active', type === 'expense');
                elements.btnIncome.classList.toggle('active', type === 'income');
                updateCategoryOptions(type);
                
                // ì˜ìˆ˜ì¦ OCR ë²„íŠ¼ì€ ì§€ì¶œ/ìˆ˜ì…ì¼ ë•Œë§Œ í‘œì‹œ (í˜„ì¬ëŠ” ëª¨ë“  ê²½ìš°ì— í‘œì‹œ)
                elements.btnOcr.style.display = 'block'; 
            }

            function openEntryModal(tx = null) {
                elements.entryModal.classList.add('show');
                
                if (tx) {
                    elements.entryId.value = tx.id;
                    currentFormType = tx.type;
                    elements.entryDate.value = tx.date;
                    elements.entryAmount.value = formatCurrency(String(tx.amount));
                    elements.entryMemo.value = tx.memo || '';
                    elements.deleteEntryBtn.style.display = 'block';
                    elements.saveEntryBtn.textContent = 'ìˆ˜ì •í•˜ê¸°';
                } else {
                    elements.entryId.value = ''; 
                    currentFormType = 'expense';
                    elements.entryDate.value = new Date().toISOString().split('T')[0];
                    elements.entryAmount.value = '';
                    elements.entryMemo.value = '';
                    elements.deleteEntryBtn.style.display = 'none';
                    elements.saveEntryBtn.textContent = 'ì €ì¥í•˜ê¸°';
                }
                
                updateFormType(currentFormType);
                if (tx) {
                    elements.entryCategory.value = tx.category;
                }
            }
            function closeEntryModal() { elements.entryModal.classList.remove('show'); }

            function handleSaveEntry() {
                const amount = parseInt(elements.entryAmount.value.replace(/,/g, ''), 10);
                const date = elements.entryDate.value;
                const category = elements.entryCategory.value;
                const memo = elements.entryMemo.value;
                const id = elements.entryId.value;

                if (!date || isNaN(amount) || amount <= 0 || !category) {
                    alert('ë‚ ì§œ, ê¸ˆì•¡, ì¹´í…Œê³ ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                let savedTx = null;
                if (id) {
                    const index = STATE.transactions.findIndex(tx => tx.id == id);
                    if (index > -1) {
                        STATE.transactions[index] = { ...STATE.transactions[index], type: currentFormType, date, amount, category, memo };
                        savedTx = STATE.transactions[index];
                    }
                } else {
                    const newTx = {
                        id: Date.now(),
                        type: currentFormType,
                        date,
                        amount,
                        category,
                        memo
                    };
                    STATE.transactions.push(newTx);
                    savedTx = newTx;
                }

                saveData();
                closeEntryModal();
                updateAllViews();
                
                runAiAdvice(savedTx); 
            }
            function handleDeleteEntry() {
                const id = elements.entryId.value;
                if (!id) return;
                
                if (confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    STATE.transactions = STATE.transactions.filter(tx => tx.id != id);
                    saveData();
                    closeEntryModal();
                    updateAllViews();
                    alert('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // --- ğŸŒŸ AI/OCR ê´€ë ¨ ë¡œì§ (ê°€ìƒ êµ¬í˜„) ---
            function handleOcrUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const ocrKey = localStorage.getItem('ocrApiKey');
                if (!ocrKey) {
                     alert('ì„¤ì • > OCR API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                     event.target.value = null; 
                     return;
                }
                
                alert('ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤...');
                
                const isMart = file.name.toLowerCase().includes('mart') || file.name.toLowerCase().includes('market');
                const virtualOcrResult = {
                    success: true,
                    category: isMart ? 'ë§ˆíŠ¸' : 'ì™¸ì‹',
                    date: new Date().toISOString().split('T')[0],
                    amount: isMart ? 48500 : 18900,
                    memo: isMart ? 'OOë§ˆíŠ¸ ì¥ë³´ê¸°' : 'OOì¹˜í‚¨ ê²°ì œ'
                };
                
                if (virtualOcrResult.success) {
                    updateFormType('expense');
                    elements.entryDate.value = virtualOcrResult.date;
                    elements.entryAmount.value = formatCurrency(String(virtualOcrResult.amount));
                    elements.entryMemo.value = virtualOcrResult.memo;

                    const categoryElement = elements.entryCategory;
                    const options = Array.from(categoryElement.options).map(o => o.value);
                    if (options.includes(virtualOcrResult.category)) {
                        categoryElement.value = virtualOcrResult.category;
                    } else {
                        categoryElement.value = CATEGORIES.expense[0]; 
                    }
                    
                    alert(`OCR ì¸ì‹ ì™„ë£Œ! ${virtualOcrResult.memo} (${formatCurrencyWithWon(virtualOcrResult.amount)})ì´(ê°€) ìë™ìœ¼ë¡œ ê¸°ì…ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ í™•ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.`);

                } else {
                    alert('OCR ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                
                event.target.value = null; 
            }

            function runAiAdvice(latestTx) {
                const aiKey = localStorage.getItem('aiApiKey');
                if (!aiKey) return; 
                
                const month = new Date(latestTx.date).getMonth() + 1;
                const adviceText = latestTx.type === 'expense'
                    ? `ì´ë²ˆ ë‹¬ **${latestTx.category}** ì§€ì¶œì´ ì§€ë‚œ ë‹¬ í‰ê·  ëŒ€ë¹„ ${Math.floor(Math.random() * 30) + 10}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ì˜ˆì‚°ì„ ì ê²€í•´ë³´ì„¸ìš”!`
                    : `${month}ì›”ì˜ ìˆ˜ì…ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ íë¦„ì„ ìœ ì§€í•˜ë©´ ì˜¬í•´ ëª©í‘œ ì €ì¶•ì•¡ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`;

                elements.aiAdviceText.innerHTML = adviceText;
                elements.aiAdviceModal.style.display = 'flex';
            }

            // --- ì„¤ì • í˜ì´ì§€ ë¡œì§ ---
            function applyTheme(theme) {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                elements.darkModeToggle.checked = theme === 'dark';
                STATE.currentTheme = theme;
                localStorage.setItem('theme', theme);
                if (elements.statsPage.classList.contains('active')) {
                     renderStats(); 
                }
            }
            function saveApiKeys() { 
                localStorage.setItem('aiApiKey', elements.aiApiKey.value);
                localStorage.setItem('ocrApiKey', elements.ocrApiKey.value);
                alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            function loadApiKeys() { 
                elements.aiApiKey.value = localStorage.getItem('aiApiKey') || '';
                elements.ocrApiKey.value = localStorage.getItem('ocrApiKey') || '';
            }
            function backupData() { 
                const dataStr = JSON.stringify(STATE.transactions, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ê°€ê³„ë¶€_ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            function restoreData() { elements.restoreDataInput.click(); }
            function handleRestoreFile(event) { 
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (Array.isArray(restoredData) && restoredData.every(item => item.id && item.type && item.amount)) {
                            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë³µêµ¬ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                STATE.transactions = restoredData;
                                saveData();
                                updateAllViews();
                                alert('ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        } else {
                            alert('ì˜ëª»ëœ í˜•ì‹ì˜ íŒŒì¼ì…ë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        alert('íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        console.error('Restore Error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            }


            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© ---
            elements.navBtns.forEach(btn => {
                const pageId = btn.dataset.page;
                if (pageId) {
                    btn.addEventListener('click', () => changePage(pageId));
                }
            });

            elements.addEntryBtn.addEventListener('click', () => openEntryModal());
            elements.cancelEntryBtn.addEventListener('click', closeEntryModal);
            elements.entryModal.addEventListener('click', (e) => {
                if (e.target.id === 'entry-modal') closeEntryModal(); // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            });
            elements.saveEntryBtn.addEventListener('click', handleSaveEntry);
            elements.deleteEntryBtn.addEventListener('click', handleDeleteEntry);
            
            elements.btnExpense.addEventListener('click', () => updateFormType('expense'));
            elements.btnIncome.addEventListener('click', () => updateFormType('income'));
            elements.entryCategory.addEventListener('change', () => {
                const category = elements.entryCategory.value;
                const isExpense = CATEGORIES.expense.includes(category);
                const isIncome = CATEGORIES.income.includes(category);
                if (isExpense && currentFormType !== 'expense') updateFormType('expense');
                if (isIncome && currentFormType !== 'income') updateFormType('income');
            });


            // ì„¤ì • í˜ì´ì§€ ë¦¬ìŠ¤ë„ˆ
            elements.darkModeToggle.addEventListener('change', (e) => {
                applyTheme(e.target.checked ? 'dark' : 'light');
            });
            elements.saveApiKeysBtn.addEventListener('click', saveApiKeys);
            elements.backupDataBtn.addEventListener('click', backupData);
            elements.restoreDataBtn.addEventListener('click', restoreData);
            elements.restoreDataInput.addEventListener('change', handleRestoreFile);

            // AI/OCR ë¦¬ìŠ¤ë„ˆ
            elements.btnOcr.addEventListener('click', () => {
                const ocrKey = localStorage.getItem('ocrApiKey');
                if (!ocrKey) {
                    alert('ì„¤ì • > OCR API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    changePage('settings-page');
                } else {
                    elements.ocrReceiptInput.click();
                }
            });
            elements.ocrReceiptInput.addEventListener('change', handleOcrUpload);
            elements.aiAdviceCloseBtn.addEventListener('click', () => {
                elements.aiAdviceModal.style.display = 'none';
            });
            
            elements.prevMonthBtn.addEventListener('click', () => {
                STATE.currentDate.setMonth(STATE.currentDate.getMonth() - 1);
                updateAllViews();
            });

            elements.nextMonthBtn.addEventListener('click', () => {
                STATE.currentDate.setMonth(STATE.currentDate.getMonth() + 1);
                updateAllViews();
            });


            // --- ì´ˆê¸°í™” ---
            function updateAllViews() {
                renderCalendar();
                if (elements.statsPage.classList.contains('active')) {
                     renderStats(); 
                }
            }

            function initialize() {
                applyTheme(STATE.currentTheme);
                loadApiKeys();
                updateCategoryOptions(currentFormType); 
                updateAllViews();
                
                Chart.defaults.font.family = 'Nanum Gothic, sans-serif';
                Chart.defaults.color = 'var(--text-color)';
            }

            // DOMContentLoadedê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
            initialize();
        });
    </script>
</body>
</html>
